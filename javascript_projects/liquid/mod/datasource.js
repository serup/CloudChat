	
	/*
		Copyright (c) 2010-2013 Liquid Working Group. All Rights Reserved.
		Available on MIT license (see: http://www.jsliquid.com/license.html)
	*/
	
	jsl.__ploads.datasource='try{jsl}catch(e){throw Error("liquid(error) >> [DataSource] module not loaded - cause: jsl core not found")}if(!jsl||jsl.__magic!=="J345NN48H756PQ56"){throw Error("liquid(error) >> [DataSource] module not loaded - cause: jsl core not found (bad magic number)")}if(!jsl.__ready){throw Error("liquid(error) >> [DataSource] module not loaded - cause: previous jsl core error")}if(jsl.__mods.datasource){jsl.console.warn("[DataSource] module already loaded")}if(!jsl.__mods.datasource){jsl.__mods.push("datasource");jsl.__mods.datasource="0.82";if(jsl.__mods.datasource!==jsl.__version){throw jsl.ConfigError("BadVersion",["Datasource module",jsl.__mods.datasource,jsl.__version])}jsl.setMessage("e.ds.BadValue","<$> read invalid value from datasource");jsl.setMessage("e.ds.InvalidKey","<$> invalid key assignment on incompatible column");jsl.setMessage("e.ds.ReadOnly","operation denied, datasource readonly");jsl.setMessage("e.ds.TypeNotDefined","<$> datasource type not defined");jsl.setMessage("e.dst.BadFilter","an error has occurred on the execution of the current filter$? at $");jsl.setMessage("e.dst.BadId","<id> invalid identifier, expected @ as first character");jsl.setMessage("e.dst.BadPosition","impossible complete the operation, index out of dataset");jsl.setMessage("e.dst.BadRowSize","<$> the row has more elements than expected");jsl.setMessage("e.dst.BadVirtual","<$> an error has occurred on the compute of the virtual field");jsl.setMessage("e.dst.ChunkNotLoaded","impossible complete the operation: chunk not loaded");jsl.setMessage("e.dst.InvalidSort","impossible execute a function sort on a chunked dataset");jsl.setMessage("e.dst.Locked","impossible complete the operation: dataset locked to wait the end of another operation");jsl.setMessage("e.dst.NegativePosition","impossible complete the operation: negative position");jsl.setMessage("e.dst.OperationNegated","impossible complete the operation on the dataset because some active changes are not yet committed or reverted");jsl.setMessage("e.dst.ReadOnly","impossible complete the current operation: the dataset is readonly");jsl.setMessage("e.dst.RefreshNegated","impossible refresh the dataset because some active changes are not yet committed or reverted");jsl.setMessage("e.dst.exp.InvalidToken","<rule(exp)> syntax error on the filter expression: invalid token \'$\'");jsl.setMessage("e.dst.exp.MissingBracket","<rule(exp)> syntax error on the filter expression: missing ) in parenthetical");jsl.setMessage("e.dst.exp.SyntaxError","<rule(exp)> syntax error on the filter expression");jsl.setMessage("e.dst.exp.UnclosedString","<rule(exp)> syntax error on the filter expression: unterminated string literal");jsl.setMessage("e.dst.exp.InvalidField","<rule(exp)> error on the filter expression: field not defined \'$\'");jsl.setMessage("e.dst.exp.InvalidIdType","<rule(exp)> error on the filter expression: invalid operation on field \'$\'");jsl.setMessage("e.dst.exp.InvalidMarkerId","<rule(exp)> error on the filter expression: invalid marker number (@0)");jsl.setMessage("e.dst.exp.InvalidOpOnBExp","<rule(exp)> error on the filter expression: invalid operation on boolean");jsl.setMessage("e.dst.exp.InvalidOpOnNExp","<rule(exp)> error on the filter expression: invalid operation on number");jsl.setMessage("e.dst.exp.InvalidOpOnSExp","<rule(exp)> error on the filter expression: invalid operation on string");jsl.setMessage("e.dst.exp.InvalidParam","<params($)> invalid param, expected a primitive value or filed name");jsl.setMessage("e.dst.exp.ParamNotDefined","<params($)> the parameter expected from the @$ marker is not found");jsl.setMessage("e.dst.net.BadData","<$> invalid data fetched from the connection stream$?: found $");jsl.setMessage("e.dst.net.BadMetaData","invalid metadata fetched from the connection stream");jsl.setMessage("e.dst.net.BadMetaData2","<$> invalid metadata, expected at least one concrete (not virtual) column");jsl.setMessage("e.dst.net.BadRowSize","<rows[$]> invalid data fetched from the connection stream: invalid row size, found $ but expected $");jsl.setMessage("e.dst.net.BadRowType","<rows[$]> invalid data fetched from the connection stream: expected object, found $");jsl.setMessage("e.dst.net.BadRows","<rows> invalid data fetched from the connection stream: expected array type, found $");jsl.setMessage("e.dst.net.MetaDataNotFound","no metadata found. Impossible detection from empty data");jsl.setMessage("e.dst.db.BadMetaData","<$> found wrong metadata default value");jsl.setMessage("e.dst.db.BadQuery","query with errors");jsl.setMessage("e.dst.db.InvalidMarker","<@$> invalid marker, parameter not found");jsl.setMessage("e.dst.db.InvalidMetaData","<$> invalid metadata, expected only virtual fields");jsl.setMessage("e.dst.db.NoMultipleQueries","expected a single connection query");jsl.setMessage("info.dst.db.Refresh","automatic refresh on dataset $");jsl.setMessage("info.dst.db.SilentCommit","silent commit executed on dataset $");jsl.DataSource=(function(){try{var a;a=new jsl.Module("jsl.DataSource");a.__cs={};a.__ds={};a.addEvents("beforeType","beforeDefine","beforeConnect","beforeExecute");a.addEvents("type","define","connect","execute");a.addOption("datasource");a.addOption("datasource.type",{dvalue:"net",setter:function(c,d,f){/*!*/jsl.validate(c,"s+",f);if(!this.__cs[c.toLowerCase()]){throw jsl.ParamError("e.ds.TypeNotDefined",[c])}/*!*/return c.toLowerCase()}});return a}catch(b){jsl.throwError(b,"jsl.DataSource")}})();jsl.DataSource.type=function(c,a){try{var b;/*!*/if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(c,"s+","id");if(c.indexOf(".")!==-1){throw jsl.ParamError("BadCharacter:id:.")}jsl.validate(a,"o","connector");if(!this.Connector.isImplementedBy(a)){throw jsl.ParamError("InterfaceNotImplemented:connector:DataSource.Connector")}/*!*/b=new jsl.Event;b.typeId=c+"";b.connector=a;this.throwEvent("beforeType",b);this.__cs[c.toLowerCase()]=jsl.Object.clone(a);this.throwEvent("type",b);return this}catch(b){jsl.throwError(b,this,arguments)}};jsl.DataSource.define=function(h,a){try{var f,b,g,c,d;/*!*/if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(h,"s+","id");jsl.validate(a,"t(s+,o)","options");/*!*/f=h.toLowerCase().split(".");b=f.length>=2?f[0]:this.getOption("datasource.type");g=f.length>=2?f[1]:f[0];/*!*/if(f.length>2){throw jsl.ParamError("BadSyntax:      id")}if(!b){throw jsl.ParamError("EmptyString:    id(type)")}if(!g){throw jsl.ParamError("EmptyString:    id(datasource)")}if(!this.__cs[b]){throw jsl.ParamError("NotDefined:     id(type)")}if(this.__ds[g]){throw jsl.ParamError("AlreadyDefined: id(id)")}/*!*/if(jsl.isString(a)){c={location:a}}else{c=jsl.Object.clone(a)}/*!*/if(c.location==null){throw jsl.ParamError("Required:options.location")}if(c.readonly!=null){jsl.validate(c.readonly,"b","options.readonly")}jsl.validate(c.location,"s+","options.location");/*!*/c.id=g;c.type=b;c.readonly=!!+c.readonly;c.location=c.location+"";d=new jsl.Event;d.datasource=c;this.throwEvent("beforeDefine",d);this.__cs[b].define(c,a);this.__ds[g]=c;this.throwEvent("define",d);return this}catch(d){jsl.throwError(d,this,arguments)}};jsl.DataSource.connect=function(b,r){try{var h,q,c,i,k,p,n,j,g,m;/*!*/if(!arguments.length||arguments.length>2){throw jsl.ParamError()}jsl.validate(b,"s+","id");if(arguments.length===2&&r==null){throw jsl.ParamError("NullValue:options")}/*!*/q=b.toLowerCase().split(".");if(q.length>2){q[1]=q.slice(1).join(".")}c=this.__ds[q[0]];i=q[1];h={};/*!*/if(!q[0]){throw jsl.ParamError("EmptyString:  id(datasource)")}if(!c){throw jsl.ParamError("NotDefined:   id(datasource)")}if(q.length>=2&&!i){throw jsl.ParamError("EmptyString:  id(table)")}/*!*/if(jsl.isArray(r)){h.metadata=r}else{if(jsl.isFunction(r)){h.onConnect=r}else{if(jsl.isObject(r)){h=jsl.Object.clone(r)}else{if(arguments.length===2){h.option=r}}}}if(h.readonly==null){h.readonly=c.readonly}/*!*/if(h.onConnect!=null){jsl.validate(h.onConnect,"f","options.onConnect")}if(h.onCommit!=null){jsl.validate(h.onCommit,"f","options.onCommit")}if(h.onRefresh!=null){jsl.validate(h.onRefresh,"f","options.onRefresh")}if((h.onCommit||h.onRefresh)&&!h.onConnect){throw jsl.ParamError("Expected:options.onConnect")}jsl.validate(h.readonly,"b","options.readonly");if(h.readonly===false&&c.readonly){throw jsl.ParamError("OperationDenied:options.readonly")}/*!*/if(h.metadata!=null){n=h.metadata=this.__md(h.metadata,"options.metadata");for(var o=0,d=n.length;o<d;o++){if(n[o].type==="v"){n.virtuals=true}else{n.reals=true}}}h.readonly=!!+h.readonly;k=new jsl.Event;k.datasource=c;k.table=i;k.options=h;this.throwEvent("beforeConnect",k);j=h.onConnect;p=jsl.Object.clone(this.__cs[c.type]);if(j){g=this;m=arguments;h.onReady=function(a){a.__cn=p;a.__cn.ASY=true;a.__ods=a.__ds.slice();a.onCommit=h.onCommit;a.onRefresh=h.onRefresh;k.dataset=a;try{j.call(g,k)}catch(f){throw jsl.ParamError("ScriptError:options.onConnect",f).trace(g,m)}g.throwEvent("connect",k)};p.connect(c,i,h);c=null}else{c=p.connect(c,i,h);c.__cn=p;c.__ods=c.__ds.slice();k.dataset=c;this.throwEvent("connect",k)}return c}catch(k){jsl.throwError(k,this,arguments)}};jsl.DataSource.execute=function(a,d,h){try{var k,b,i,f,j,c,g;/*!*/if(arguments.length<2||arguments.length>3){throw jsl.ParamError()}jsl.validate(a,"s+","id");if(d==null){throw jsl.ParamError("NullValue:command")}if(arguments.length===3){jsl.validate(h,"f","onExecute")}/*!*/k=a.toLowerCase().split(".");b=this.__ds[k[0]];/*!*/if(k.length>1){throw jsl.ParamError("Expected:   id=datasource")}if(!b){throw jsl.ParamError("NotDefined: id(datasource)")}/*!*/i=this.__cs[b.type];f=new jsl.Event;f.datasource=b;f.command=d;this.throwEvent("beforeExecute",f);if(h){c=this;g=arguments;i.execute(b,d,function(l){f.result=l;try{h.call(c,f)}catch(m){throw jsl.ParamError("ScriptError:options.onExecute",m).trace(c,g)}this.throwEvent("execute",f)});j=null}else{j=f.result=i.execute(b,d);this.throwEvent("execute",f)}return j}catch(f){jsl.throwError(f,this,arguments)}};jsl.DataSource.__toNative=function(c,d){try{var h,f,a,b;if(c==null){b=null}else{if(jsl.isString(c)){b=c+""}else{if(jsl.isBoolean(c)){b=!!+c}else{if(jsl.isNumber(c)){b=+c}else{if(jsl.isDate(c)){b=+c}else{h=jsl.require("data");f=h.__XML_OPTS;a=h.__JSN_OPTS;if(d==="any"){b=h.serialize(c)}else{if(c instanceof h.Blob){b=c.toString(16)}else{if(c instanceof h.XNode){b=h.toXml(c,f)}else{b=h.toJson(c,a)}}}}}}}}return b}catch(g){jsl.throwError(g,this,arguments)}};jsl.DataSource.__fromNative=function(c,d,a){var b;b=c;switch(d){/*!*/case"i":if(!jsl.isInteger(c)){throw jsl.DataError("e.ds.BadValue",[a])}break;case"n":if(isNaN(c)){throw jsl.DataError("e.ds.BadValue",[a])}if(!isFinite(c)){throw jsl.DataError("e.ds.BadValue",[a])}break;case"i+":if(!jsl.isInteger(c)||c<0){throw jsl.DataError("e.ds.BadValue",[a])}break;case"n+":if(isNaN(c)||c<0){throw jsl.DataError("e.ds.BadValue",[a])}if(!isFinite(c)){throw jsl.DataError("e.ds.BadValue",[a])}break;case"i++":if(!jsl.isInteger(c)||c<=0){throw jsl.DataError("e.ds.BadValue",[a])}break;case"n++":if(isNaN(c)||c<=0){throw jsl.DataError("e.ds.BadValue",[a])}if(!isFinite(c)){throw jsl.DataError("e.ds.BadValue",[a])}break;case"s":if(typeof c!=="string"){throw jsl.DataError("e.ds.BadValue",[a])}break;case"s+":if(typeof c!=="string"||!c.length){throw jsl.DataError("e.ds.BadValue",[a])}break ;/*!*/case"b":/*!*/if(c!==true&&c!==false&&c!==0&&c!==1){throw jsl.DataError("e.ds.BadValue",[a])}/*!*/b=!!c;break;case"d":/*!*/if(!jsl.isInteger(c)||c<=0){throw jsl.DataError("e.ds.BadValue",[a])}/*!*/b=new Date(c);break;case"blob":/*!*/if(c!==null&&typeof c!=="string"){throw jsl.DataError("e.ds.BadValue",[a])}/*!*/if(c!==null){b=new ((jsl.Data||jsl.require("data")).Blob)(jsl.Data.Blob.HEX+c)}break;case"json":/*!*/if(c!==null&&typeof c!=="string"){throw jsl.DataError("e.ds.BadValue",[a])}/*!*/if(c!==null){b=(jsl.Data||jsl.require("data")).fromJson(c,jsl.Data.__JSN_OPTS)}break;case"xml":/*!*/if(c!==null&&typeof c!=="string"){throw jsl.DataError("e.ds.BadValue",[a])}/*!*/if(c!==null){b=(jsl.Data||jsl.require("data")).fromXml(c,jsl.Data.__XML_OPTS)}break;case"any":if(typeof c==="string"&&c.slice(0,5)==="JSL~S"){b=(jsl.Data||jsl.require("data")).deserialize(c)}}return b};jsl.DataSource.__md=function(q,i){try{var p,o,d,j,s,g,n,f,b,m;p=null;if(q){f=i||"metadata";/*!*/jsl.validate(q,"a",f);/*!*/p=[];b=jsl.Data;for(var r=0,h=q.length;r<h;r++){i=f+"["+r+"]";/*!*/jsl.validate(q[r],"t(o,s+)",i);/*!*/o=q[r];if(jsl.isString(o)){d=o;j=false;s="s";g=""}else{d=o.id;j=o.key;s=o.type;g=o.value}/*!*/jsl.validate(d,"s+",i+"(id)");j!=null&&jsl.validate(j,"b",i+"(key)");/*!*/i=f+"[id="+d+"]";/*!*/if(s!=null){jsl.validate(s,"sr/^((i|n)\\\\+{0,2}|s|s\\\\+|b|d|v|any|blob|xml|json)$",i+"(type)")}/*!*/if(!s){s="s"}n=s.charAt(0);if(n==="i"||n==="n"){/*!*/o.hasOwnProperty("value")&&jsl.validate(g,s,i+"(value)");/*!*/if(g!=null){g=+g}else{if(s.slice(-2)==="++"){g=1}else{g=0}}}else{if(n==="s"){/*!*/o.hasOwnProperty("value")&&jsl.validate(g,s,i+"(value)");/*!*/if(g!=null){g=g+""}else{if(s==="s"){g=""}else{g=" "}}}else{if(s==="b"){/*!*/o.hasOwnProperty("value")&&jsl.validate(g,"b",i+"(value)");/*!*/g=!!+g}else{if(s==="d"){/*!*/o.hasOwnProperty("value")&&jsl.validate(g,"d",i+"(value)");/*!*/g=g||new Date}else{if(s==="v"){/*!*/if(j){throw jsl.ParamError("e.ds.InvalidKey:"+i)}jsl.validate(g,"f",i+"(value)")/*!*/}else{if(s==="blob"){/*!*/if(j){throw jsl.ParamError("e.ds.InvalidKey:"+i)}if(g!=null&&!(b||jsl.require("data")).Blob.isClassOf(g)){throw jsl.ParamError("BadType:"+i+"(value):jsl.Data.Blob")}/*!*/g=g||null}else{if(s=="xml"){/*!*/if(j){throw jsl.ParamError("e.ds.InvalidKey:"+i)}if(g!=null&&!(b||jsl.require("data")).XNode.isClassOf(g)){throw jsl.ParamError("BadType:"+i+"(value):jsl.Data.XNode")}/*!*/g=g||null}else{if(s=="json"){/*!*/if(j){throw jsl.ParamError("e.ds.InvalidKey:"+i)}g!=null&&jsl.validate(g,"o",i+"(value)");/*!*/g=g||null}else{/*!*/if(j){throw jsl.ParamError("e.ds.InvalidKey:"+i)}/*!*/if(!o.hasOwnProperty("value")){g=null}}}}}}}}}p[r]={id:d+"",type:s+"",key:!!+j,value:g};if(p[r].key){m=true}p["."+d]=p[r]}}p.hasK=!!m;return p}catch(k){jsl.throwError(k,this,arguments)}};jsl.Class("jsl.DataSource.DataSet",{inherits:[jsl.OptionMap,jsl.EventMap],initializer:function(){var a;this.setFunction("min",function(h){var f,g,j,i;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(h,"t(s+,i+)","column");/*!*/i=this.metadata();/*!*/if(jsl.isNumber(h)&&h>=i.length){throw jsl.ParamError("NotDefined:column")}if(jsl.isString(h)&&!i["."+h]){throw jsl.ParamError("NotDefined:column")}g=(jsl.isString(h)?i["."+h]:i[h]).type;if(g.search(/i|n/i)){throw jsl.ParamError("BadType:column:number")}/*!*/f=Infinity;j=this.column(h);for(var d=0,b=j.length;d<b;d++){if(j[d]<f){f=j[d]}}return b?f:null});this.setFunction("max",function(h){var f,g,j,i;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(h,"t(s+,i+)","column");/*!*/i=this.metadata();/*!*/if(jsl.isNumber(h)&&h>=i.length){throw jsl.ParamError("NotDefined:column")}if(jsl.isString(h)&&!i["."+h]){throw jsl.ParamError("NotDefined:column")}g=(jsl.isString(h)?i["."+h]:i[h]).type;if(g.search(/i|n/i)){throw jsl.ParamError("BadType:column:number")}/*!*/f=-Infinity;j=this.column(h);for(var d=0,b=j.length;d<b;d++){if(j[d]>f){f=j[d]}}return b?f:null});this.setFunction("avg",function(h){var f,g,j,i;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(h,"t(s+,i+)","column");/*!*/i=this.metadata();/*!*/if(jsl.isNumber(h)&&h>=i.length){throw jsl.ParamError("NotDefined:column")}if(jsl.isString(h)&&!i["."+h]){throw jsl.ParamError("NotDefined:column")}g=(jsl.isString(h)?i["."+h]:i[h]).type;if(g.search(/i|n/i)){throw jsl.ParamError("BadType:column:number")}/*!*/f=0;j=this.column(h);for(var d=0,b=j.length;d<b;d++){f+=j[d]}return b?f/b:null});this.setFunction("sum",function(h){var f,g,j,i;if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(h,"t(s+,i+)","column");i=this.metadata();if(jsl.isNumber(h)&&h>=i.length){throw jsl.ParamError("NotDefined:column")}if(jsl.isString(h)&&!i["."+h]){throw jsl.ParamError("NotDefined:column")}g=(jsl.isString(h)?i["."+h]:i[h]).type;if(g.search(/i|n/i)){throw jsl.ParamError("BadType:column:number")}f=0;j=this.column(h);for(var d=0,b=j.length;d<b;d++){f+=j[d]}return b?f:null});jsl.Object.merge(this,jsl.OptionMap.prototype);this.OptionMap();this.addOption("readonly",{dvalue:false,setter:function(b,c,d){jsl.validate(b,"b",d);return !!+b}});this.addOption("pagesize",{dvalue:10,setter:function(b,c,d){jsl.validate(b,"i++",d);return +b}});this.addOption("autocommit",{dvalue:false,setter:function(b,c,d){jsl.validate(b,"b",d);return !!+b}});this.addOption("refresh",{dvalue:0,setter:function(b,c,d){jsl.validate(b,"t(b,i+)",d);return jsl.isBoolean(b)?(b==true?10:+b):+b}});a=this.prototype;a.OptionMap();a.addOption("readonly",{dvalue:false,setter:function(b,c,d){jsl.validate(b,"b",d);if(this.__md){throw jsl.MisuseError("OperationDenied")}return this.__ro=!!+b}});a.addOption("pagesize",{dvalue:10,setter:function(b,c,d){jsl.validate(b,"i++",d);return this.__ps=+b}});a.addOption("autocommit",{dvalue:false,setter:function(b,c,d){jsl.validate(b,"b",d);return this.__ac=!!+b}});a.addOption("refresh",{dvalue:0,setter:function(b,f,g){var d,c;jsl.validate(b,"t(b,i+)",g);if(this.__tid){jsl.removeTimer(this.__tid);this.__tid=null}if(+b){d=this;c=jsl.isBoolean(b)?10:+b;this.__tid=jsl.timer(function(){var h;if(!(d.__rn+d.__an+d.__un)){d.refresh()}h=d.getName()!=="jsl.DataSource.DataSet"?d.getName():d.__n;jsl.console.info("info.dst.db.Refresh",[h])},c*1000)}return c||0}});a.EventMap();a.addEvents("beforeRead","beforeChange","beforeSave","beforeInsert","beforeRemove","beforeClear","beforeFilter","beforeInject","beforeSort","beforeExecute","beforeRefresh","beforeCommit","beforeRevert");a.addEvents("read","change","save","insert","remove","clear","filter","inject","sort","execute","refresh","commit","revert")},st___fs:{},st___os:{},st___ts:{},__fs:null,__os:null,__ts:null,__n:0,__id:0,__md:null,__vs:null,__ft:null,__lk:false,__hds:{any:1,json:1,xml:1,blob:1,d:1},__cn:null,__tid:null,__ds:null,__ods:null,__ix:0,__lx:0,__rm:null,__am:null,__um:null,__rn:0,__an:0,__un:0,__fn:0,__ps:10,__ac:false,__ro:false,st_setFilter:function(b,a){if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"sr/^[^\\\\s&|<>=!+*\\\\/()@]+$","id");jsl.validate(a,"t(f,s+)","filter");this.__fs["@"+b.toLowerCase()]=a.valueOf();return this},st_setOrder:function(b,a){if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"s+","id");jsl.validate(a,"t(f,s+)","order");this.__os["@"+b.toLowerCase()]=a.valueOf();return this},st_setFunction:function(b,a){if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"s+","id");jsl.validate(a,"f","f");this.__ts["@"+b.toLowerCase()]=a;return this},DataSet:function(i,m){var c,g,h,k,d;if(arguments.length>2){throw jsl.ParamError()}if(arguments.length&&!jsl.DataSource.DataSet.isClassOf(i)){jsl.validate(i,"a","metadata")}if(arguments.length===2){jsl.validate(m,"o","options")}this.EventMap();this.OptionMap();c=jsl.DataSource;this.__cn=this.__clone(c.CMemory);d=c.DataSet.getOptions();if(m){d=jsl.Object.merge(d,m)}this.setOptions(d);this.__ds=[];this.__ods=[];this.__rm={};this.__am={};this.__um={};this.__n=c.DataSet.prototype.__n++;this.__vs=[];this.__md=h=arguments.length?c.__md(i instanceof Array?i:i.metadata()):[];k=[];for(var j=0,b=h.length;j<b;j++){if(h[j].type==="v"){this.__vs.push(h[j].id)}else{k[j]=this.__hds[h[j].type]}}this.__hds=k;g=function(){};g.prototype=c.DataSet.__fs;this.__fs=new g;g.prototype=c.DataSet.__os;this.__os=new g;g.prototype=c.DataSet.__ts;this.__ts=new g},type:function(){if(arguments.length){throw jsl.ParamError()}return this.__cn.type()},connector:function(){if(arguments.length){throw jsl.ParamError()}return this.__cn.refresh?this.__cn:null},metadata:function(a){var b;if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(a,"t(i+,s+)","column")}b=this.__md;if(arguments.length){if(jsl.isString(a)){b=b["."+a]}else{b=b[a]}if(!b){throw jsl.ParamError("NotDefined:column")}b=this.__clone(b)}else{b=this.__clone(b,2)}return b},count:function(a){var b;if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(a,"si(pages)","pages")}b=this.__ds.length-this.__fn;b=a?Math.ceil(b/this.__ps):b;return b},setFilter:function(b,a){/*!*/if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"sr/^[^\\\\s&|<>=!+*\\\\/()@]+$","id");jsl.validate(a,"t(f,s+)","filter");/*!*/this.__fs["@"+b.toLowerCase()]=a.valueOf();return this},setOrder:function(b,a){/*!*/if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"s+","id");jsl.validate(a,"t(f,s+)","order");/*!*/this.__os["@"+b.toLowerCase()]=a.valueOf();return this},setFunction:function(b,a){/*!*/if(arguments.length!==2){throw jsl.ParamError()}jsl.validate(b,"s+","id");jsl.validate(a,"f","f");/*!*/this.__ts["@"+b.toLowerCase()]=a;return this},toString:function(u,c){var B,w,d,h,g,A,p,z,k,m,t,o,j,x,q,n;/*!*/if(arguments.length===2){jsl.validate(c,"o","options")}if(c&&c.header!=null){jsl.validate(c.header,"b","options.header")}/*!*/h=jsl.isString(u)?u.toLowerCase():null;if(h==="xml"||h==="json"||h==="csv"){B=this.__md;w=B.length;d=c||{};g=this.__read(Infinity,0);p=g.length;if(h==="json"){/*!*/if(d.mode!=null){jsl.validate(d.mode,"si(verbose,compact)","options.mode")}if(d.prettify!=null){jsl.validate(d.prettify,"b","options.prettify")}if(d.extended!=null){jsl.validate(d.extended,"b","options.extended")}/*!*/if(!d.mode||d.mode.toLowerCase()==="compact"){A=0;if(+d.header){m=[];for(z=0;z<w;z++){m[z]=B[z].id}g.unshift(m);A++}for(;A<p;A++){m=[];for(z=0;z<w;z++){m[z]=g[A].r[B[z].id]}g[A]=m}}else{for(A=0;A<p;A++){g[A]=g[A].r}}delete d.transform;delete d.filter;try{k=jsl.Data.toJson(g,d)}catch(y){throw (y instanceof jsl.MisuseError?y.clearStackTrace():y)}}else{if(h==="csv"){try{k=jsl.Data.toCsv(this,d)}catch(y){throw (y instanceof jsl.MisuseError?y.clearStackTrace():y)}}else{if(h==="xml"){/*!*/if(d.prettify!=null){jsl.validate(d.prettify,"b","options.prettify")}if(d.mode!=null){jsl.validate(d.mode,"si(element,attribute)","options.mode")}/*!*/k=[];A=0;q=0;if(d.header){k[q++]=\'<?xml version="1.0" encoding="UTF-8" ?>\'}if(+d.prettify){t="\\n\\t",o="\\n\\t\\t"}else{t="",o=""}k[q++]=(+d.prettify?"\\n":"")+"<rows>";if(!d.mode||d.mode.toLowerCase()==="element"){for(A=0;A<p;A++){k[q++]=t+"<row>";for(z=0;z<w;z++){n=B[z].id;j=(g[A].r[n]+"").replace(/</g,"&lt;").replace(/&/g,"&amp;");k[q++]=o+"<"+n+">"+j+"</"+n+">"}k[q++]=t+"</row>"}}else{x=function(a){switch(a){case"<":return"&lt;";case"&":return"&amp;";case\'"\':return"&quot;";case"\\n":return"&#10;";case"\\r":return"&#13;"}};for(A=0;A<p;A++){k[q++]=t+"<row";for(z=0;z<w;z++){n=B[z].id;j=(g[A].r[n]+"").replace(/[<&"\\n\\r]/g,x);k[q++]=" "+n+\'="\'+j+\'"\'}k[q++]=" />"}}k[q++]=(+d.prettify?"\\n":"")+"</rows>";k=k.join("")}}}}else{k="DataSet(type="+this.type()+", count="+(this.__ds.length-this.__fn)+")"}return k},toArray:function(p){var l,q,m,c,k,j,g,h;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length===1){jsl.validate(p,"b","objects")}/*!*/l=this.__md;q=l.length;g=this.__read(Infinity,0);h=p!=false;for(var o=0,f=g.length;o<f;o++){c=h?{}:[];k=g[o].r;if(h){for(m=0;m<q;m++){c[l[m].id]=k[l[m].id]}}else{for(m=0;m<q;m++){c[m]=k[l[m].id]}}g[o]=c}return g},valueOf:function(){return this.__ds.length-this.__fn},read:function(d,g){try{var j,s,c,m,q,l,p,u,o,h,t,k,i;/*!*/if(arguments.length>2){throw jsl.ParamError()}if(arguments.length){jsl.validate(d,"t(i++,s+)","n")}if(arguments.length===2){jsl.validate(g,"si(old)","old")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/j=new jsl.Event;q=this.hasListeners("beforeRead");l=this.hasListeners("read");this.__lk=true;u=d;if(u==="*"){u=Infinity}if(jsl.isString(u)){/*!*/if(!this.__md["."+u]){throw jsl.ParamError("NotDefined:field")}/*!*/j.row=null;j.old=null;if(q){this.throwEvent("beforeRead",j)}c=this.__read(1)[0];/*!*/if(!c){throw jsl.MisuseError("e.dst.BadPosition")}/*!*/s=g?c.o||c.r:c.r;s=s[u];this.__lk=false;if(l){j.row=c.r;j.old=c.o||null;this.throwEvent("read",j)}}else{p=+u||1;s=[];o=0;h=this.__read(p);t=this.__vs;k=this.__md;while(h[o]&&o<p){c=h[o];if(q){j.row=null;j.old=null;this.throwEvent("beforeRead",j)}s[o]=this.__cloneR(g?c.o||c.r:c.r);for(m=0;m<t.length;m++){i=k["."+t[m]].value;s[o][t[m]]=i(s[o])}if(!h[++o]||o===p){this.__lk=false}if(l){j.row=c.r;j.old=c.o||null;this.throwEvent("read",j)}}this.__lk=false;if(p===1){s=s[0]||null}else{s=s.length?s:null}}return s}catch(j){this.__lk=false;throw j}},save:function(g,p){try{var u,h,m,z,q,f,x,s,k,o,v,w,c,t,i,j;/*!*/if(!arguments.length||arguments.length>2){throw jsl.ParamError()}jsl.validate(g,"t(o,s+,i+)","field");if(this.__ro){throw jsl.MisuseError("e.dst.ReadOnly")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/u=new jsl.Event;z=this.__md;j=this.__clone;if(jsl.isString(g)){/*!*/if(!z["."+g]){throw jsl.ParamError("NotDefined:field")}if(arguments.length<2){throw jsl.ParamError("Required:value")}this.__type(g,p);/*!*/h=[{}];h[0][g]=p}else{if(jsl.isNumber(g)){/*!*/if(g>=z.length){throw jsl.ParamError("NotDefined:field")}if(arguments.length<2){throw jsl.ParamError("Required:value")}/*!*/m=z[g].id;/*!*/this.__type(m,p);/*!*/h=[{}];h[0][m]=p}else{/*!*/if(arguments.length===2){throw jsl.ParamError("NotRequired:value")}/*!*/h=g instanceof Array?g.slice():[g];for(x=0,s=h.length;x<s;x++){k=h[x];if(k instanceof Array){v=k;k={};/*!*/if(v.length>z.length){throw jsl.ParamError("e.dst.BadRowSize:rows["+x+"]")}/*!*/for(w=0;w<v.length;w++){k[z[w].id]=v[w]}}/*!*/else{jsl.validate(k,"o","rows["+x+"]")}/*!*//*!*/for(w=0;w<z.length;w++){v=z[w];if(v.id in k){this.__type(v.id,k[v.id],"rows["+x+"]("+v.id+")")}}/*!*/h[x]=k}}}q=jsl.Object.merge;t=this.__vs;f=16;if(this.hasListeners("beforeSave")){f+=1}if(this.hasListeners("beforeChange")){f+=2}if(this.hasListeners("change")){f+=4}if(this.hasListeners("save")){f+=8}o=h.length;x=0;if(o){i=this.__read(o);/*!*/if(i.length!==o){throw jsl.ParamError("e.dst.BadPosition")}/*!*/this.__lk=true}else{i=[]}while(i[x]&&o--){k=i[x];c=q(j(k.r),h[x++]);if(t.length){for(w=0,s=t.length;w<s;w++){try{c[t[w]]=z["."+t[w]].value(c)}catch(y){throw jsl.ParamError("e.dst.BadVirtual:rows["+x+"]("+t[w]+")",y)}}}f=f-16;for(m in c){if(z["."+m]&&k.r[m]!==c[m]){f+=16;break}}if(f&15){u.row=c;u.old=k.o||k.r;if(f&1){this.throwEvent("beforeSave",u)}if(f&2&&f&16){u.operation="save";this.throwEvent("beforeChange",u)}}if(f&16){if(!k.s){k.o=k.r;k.r=c;k.s=1;this.__um[k.id]=k;this.__un++}else{k.r=c}if(this.__ft){try{k.f=!!this.__ft(c)}catch(y){throw jsl.ScriptError("e.dst.BadFilter:rows["+x+"]",y)}if(k.f){this.__fn++}}}if(!o){this.__lk=false}if(f&12){if(f&4&&f&16){u.operation="save";this.throwEvent("change",u)}if(f&8){this.throwEvent("save",u)}}}if(this.__ac){this.commit()}return this}catch(u){this.__lk=false;throw u}},insert:function(h){try{var y,g,o,m,w,v,t,j,i,s,p,f,u,q,c,k;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(h,"t(o,i++)","rows")}if(this.__ro){throw jsl.MisuseError("e.dst.ReadOnly")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/f=this.__ix;/*!*/if(this.__lx>this.count()){throw jsl.ParamError("e.dst.BadPosition")}/*!*/y=this.__md;q=y.length;if(!arguments.length||jsl.isNumber(h)){g=[];m=+h||1;for(w=0;w<m;w++){g[w]={};for(v=0;v<q;v++){t=y[v];if(t.type!=="v"){g[w][t.id]=t.value}}}}else{g=h instanceof Array?h.slice():[h];for(w=0,o=g.length;w<o;w++){i=g[w];if(i instanceof Array){t=i;i={};/*!*/if(t.length>y.length){throw jsl.ParamError("e.dst.BadRowSize:rows["+w+"]")}/*!*/for(v=0;v<t.length;v++){i[y[v].id]=t[v]}}else{/*!*/jsl.validate(i,"o","rows["+w+"]");/*!*/t=i;i={};for(v=0;v<q;v++){k=y[v].id;if(t.hasOwnProperty(k)){i[k]=t[k]}}}for(v=0;v<q;v++){t=y[v];if(!(t.id in i)&&t.type!=="v"){i[t.id]=t.value}/*!*/else{this.__type(t.id,i[t.id],"rows["+w+"]("+t.id+")")}/*!*/}g[w]=i}}s=new jsl.Event;j=this.__ds;p=this.__vs;m=0;c=0;if(this.hasListeners("beforeInsert")){c+=1}if(this.hasListeners("beforeChange")){c+=2}if(this.hasListeners("change")){c+=4}if(this.hasListeners("insert")){c+=8}this.__lk=true;for(w=0,o=g.length;w<o;w++){if(p.length){for(v=0,u=p.length;v<u;v++){try{g[w][p[v]]=y["."+p[v]].value(g[w])}catch(x){throw jsl.ParamError("e.dst.BadVirtual:rows["+w+"]("+p[v]+")",x)}}}if(c){s.row=g[w];s.old=null;if(c&1){this.throwEvent("beforeInsert",s)}if(c&2){s.operation="insert";this.throwEvent("beforeChange",s)}}i={};i.__$r=true;i.s=2;i.r=g[w];i.id=this.__id++;if(f<j.length){j.splice(f,0,i)}else{j[f]=i}f++;this.__am[i.id]=i;this.__an++;if(this.__ft){try{i.f=!!this.__ft(i.r)}catch(x){throw jsl.ScriptError("e.dst.BadFilter:rows["+w+"]",x)}if(i.f){this.__fn++}}if(w===o-1){this.__lk=false}if(c&4){this.throwEvent("change",s)}if(c&8){this.throwEvent("insert",s)}}this.__lk=false;if(this.__ac){this.commit()}return this}catch(s){this.__lk=false;throw s}},append:function(b){var a;try{a=this.__lx;this.end();this.insert.apply(this,arguments);this.index(a)}catch(c){this.index(a);throw c instanceof jsl.MisuseError?c.clearStackTrace():c}return this},remove:function(d){try{var j,f,b,c,k,l,g,h;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(d,"i++","n")}if(this.__ro){throw jsl.MisuseError("e.dst.ReadOnly")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/this.__lk=true;j=new jsl.Event;f=this.__ds;c=0;if(this.hasListeners("beforeRemove")){c+=1}if(this.hasListeners("beforeChange")){c+=2}if(this.hasListeners("change")){c+=4}if(this.hasListeners("remove")){c+=8}k=+d||1;g=this.__read(k);l=0;while(g[l]&&l<k){b=g[l];if(c){j.row=b.r;j.old=b.o||null;if(c&1){this.throwEvent("beforeRemove",j)}if(c&2){j.operation="remove";this.throwEvent("beforeChange",j)}}f.splice(b.ix-l++,1);if(b.f){this.__fn--}if(!b.s){this.__rm[b.id]=b;this.__rn++}else{if(b.s===1){delete this.__um[b.id];this.__un--;this.__rm[b.id]=b;this.__rn++;b.r=b.o}else{if(b.s===2){delete this.__am[b.id];this.__an--}}}if(!g[l]||l===k){this.__lk=false}if(c&4){this.throwEvent("change",j)}if(c&8){this.throwEvent("remove",j)}}this.__lk=false;if(this.__ac){this.commit()}return this}catch(j){this.__lk=false;throw j}},clear:function(i){try{var h,c,j,g,d;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(i,"f","rule")}if(this.__ro){throw jsl.MisuseError("e.dst.ReadOnly")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/this.__lk=true;h=new jsl.Event;this.throwEvent("beforeClear",h);this.__lk=false;this.__ix=0;if(i){d=0;g=this.__read(Infinity);for(var k=0,f=g.length;k<f;k++){c=g[k];try{j=i(c.r)}catch(m){throw jsl.ParamError("BadScript:rule",m)}if(j){this.__ix=c.ix-d;this.remove();d++}}}else{if(this.count()){this.remove(this.count())}}this.__ix=this.__index();this.throwEvent("clear",h);if(this.__ac){this.commit()}return this}catch(h){this.__lk=false;this.__ix=this.__index();throw h}},inject:function(i,y){try{var g,k,d,n,h,c,j,q,w,p,u,x;/*!*/if(!arguments.length||arguments.length>2){throw jsl.ParamError()}if(arguments.length===2){jsl.validate(y,"o","options")}if(this.__ro){throw jsl.MisuseError("e.dst.ReadOnly")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}if(this.__lx>this.count()){throw jsl.ParamError("e.dst.BadPosition")}/*!*/this.__lk=true;j=new jsl.Event;j.data=i;j.options=y;this.throwEvent("beforeInject",j);p=jsl.Data;x=p.XNode;if(x.isClassOf(i)||(i instanceof Array&&x.isClassOf(i[0]))){/*!*/if(y&&y.mode){jsl.validate(y.mode,"si(element,attribute,custom)","options.mode")}if(y&&y.mode=="custom"&&!y.transform){throw jsl.ParamError("Required:options.transform")}if(y&&y.transform){jsl.validate(y.transform,"f","options.transform")}/*!*/g=x.isClassOf(i[0])?i:i.getChildren();k=this.__md;h=k.length;if(y){if(y.mode=="attribute"){d=1}else{if(y.mode=="custom"){d=2}}}for(var o=0,f=g.length;o<f;o++){if(d===2){try{c=y.transform(g[o])}catch(s){throw jsl.ParamError("BadScript:options.transform",s)}/*!*/if(typeof c!=="object"){throw jsl.ParamError("BadReturnValue:options.transform:object")}/*!*/}else{c={};for(n=0;n<h;n++){if(!d){q=g[o].select(k[n].id+"[1]"),q=q&&q[0]&&(q[0].getFirstChild()||q[0]).getValue()}else{q=g[o].getAttribute(k[n].id)}u=k[n].type;w=/^[in]/i;if(w.test(u)){c[k[n].id]=+q}else{if(u==="b"&&q=="true"){c[k[n].id]=true}else{if(u==="b"&&q=="false"){c[k[n].id]=false}else{if(u==="d"){c[k[n].id]=new Date(+q)}else{if(u==="xml"){c[k[n].id]=p.fromXml(g[o],{validate:true})}else{if(u==="json"){c[k[n].id]=p.fromJson(g[o],{extended:true})}else{if(u==="any"){c[k[n].id]=p.deserialize(g[o])}else{if(u==="blob"){c[k[n].id]=new p.Blob(p.Bolb.H+g[o])}}}}}}}}}}g[o]=c}}else{if(jsl.DataSource.DataSet.isClassOf(i)){g=i.rows()}else{if(i instanceof Array){g=i}/*!*/else{throw jsl.ParamError("BadType:data")}/*!*/}}this.__lk=false;this.insert(g);j.rows=g;this.throwEvent("inject",j);if(this.__ac){this.commit()}return this}catch(j){this.__lk=false;throw j}},filter:function(b){try{var k,h,o,j,m,i,n,g,d,c;/*!*/if(arguments.length){jsl.validate(b,"t(s+,f)","filter")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/h=Array.prototype.slice.call(arguments,1);o=jsl.isString(b);if(o&&!b.search(/^@[^\\s&|<>=!+*\\/()@]+$/)){/*!*/if(!this.__fs[b.toLowerCase()]){throw jsl.ParamError("NotDefined:filter(id)")}/*!*/k=this.__fs[b.toLowerCase()];o=jsl.isString(k)}else{k=b&&b.valueOf()}if(o){j=this.__exp(k,h);k=j.fexp}else{if(h.length){d=k;h.unshift(null);k=function(a){h[0]=a;return d.apply(jsl.__go,h)};k.nf=d+h.slice(1).join("")}}if((this.__ft?(this.__ft.nf||this.__ft):null)+""!==(k?(k.nf||k):null)+""){this.__ft=k;m=new jsl.Event;m.filter=b;m.rule=o?j.cexp:k;m.exp=o?j.exp:null;this.__lk=true;this.throwEvent("beforeFilter",m);if(!k){i=this.__ds;for(n=0,g=i.length;n<g;n++){i[n].f=false}this.__ix=this.__lx;this.__fn=0}else{this.__filter()}this.__lk=false;this.throwEvent("filter",m)}return this}catch(m){this.__lk=false;throw m}},sort:function(c){try{var h,b,q,i,n,p,g,m,j,k;/*!*/if(!arguments.length){throw jsl.ParamError()}jsl.validate(c,"t(s+,f)","order");if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/h=Array.prototype.slice.call(arguments,1);q=jsl.isString(c);if(q&&c.charAt(0)==="@"){/*!*/if(!this.__os[c.toLowerCase()]){throw jsl.ParamError("NotDefined:order(id)")}/*!*/b=this.__os[c.toLowerCase()];q=jsl.isString(b)}else{b=c}if(q){/*!*/if(arguments.length>1){throw jsl.ParamError()}/*!*/i=b.replace(/\\s+/g,"");/*!*/if(!(/^([^:,]+(:(asc|des))?(,(?!$)|$))+/i).test(i)){throw jsl.ParamError("SyntaxError:order")}/*!*/n=this.__md;i=i.split(",");for(p=0,g=i.length;p<g;p++){i[p]=m=i[p].split(":");/*!*/if(!n["."+m[0]]){throw jsl.ParamError("NotDefined:order(column="+m[0]+")")}/*!*/m[1]=!m[1]||m[1].toLowerCase()==="des"}}k=new jsl.Event;k.order=c;k.data=i;k.params=h;this.__lk=true;this.throwEvent("beforeSort",k);this.__read(Infinity,0);if(q){j=this.__sort;j.data=i;this.__ds.sort(j)}else{h.unshift(null,null);this.__ds.sort(function(d,a){h[0]=d.r;h[1]=a.r;try{return b.apply(this,h)?-1:1}catch(f){throw jsl.ParamError("BadScript:order",f)}})}if(this.__ft){this.__ix=this.__index()}this.__lk=false;this.throwEvent("sort",k);return this}catch(k){this.__lk=false;throw k}},execute:function(d){try{var c,a,b,g;/*!*/jsl.validate(d,"t(s+,f)","f");if(jsl.isString(d)&&d.charAt(0)!=="@"){throw jsl.ParamError("e.dst.BadId")}/*!*/if(jsl.isString(d)){c=this.__ts[d.toLowerCase()]}else{c=d}/*!*/if(!c){throw jsl.ParamError("NotDefined:id")}/*!*/b=Array.prototype.slice.call(arguments,1);g=new jsl.Event;g.action=d;this.__lk=true;this.throwEvent("beforeExecute",g);try{a=c.apply(this,b)}catch(h){throw jsl.ScriptError("BadScript:f",h)}this.__lk=false;this.throwEvent("execute",g);return a}catch(g){this.__lk=false;throw g}},rows:function(d){var f,j,m,s,r,h,c,k,i,g,q,o;/*!*/if(arguments.length>2){throw jsl.ParamError()}if(arguments.length===1&&!jsl.isNumber(d)){jsl.validate(d,"t(f,sr/^(=|\\\\+|-|!|!!|\\\\*)$)","filter")}if(arguments.length===1&&jsl.isNumber(d)){jsl.validate(d,"i","i1")}if(arguments.length===2){jsl.validate(arguments[0],"i","i1"),jsl.validate(arguments[1],"i","i2")}/*!*/s=0;if(jsl.isNumber(d)){k=d;i=arguments[1];g=this.count();q=k<0?g+k:(+k||0);o=i<0?g+i:(+i||g);g=o-q;if(g>0){m=this.__read(g,this.__index(q));for(j=m.length;s<j;s++){m[s]=this.__cloneR(m[s].r)}}else{m=[]}}else{m=[];f=!jsl.isString(d)||d=="="?this.__read(Infinity,0):null;j=f&&f.length;r=0;if(!d){for(;s<j;s++){m[s]=this.__cloneR(f[s].r)}}else{if(jsl.isFunction(d)){for(;s<j;s++){try{if(d(f[s].r)){m[r++]=this.__cloneR(f[s].r)}}catch(p){throw jsl.ParamError("BadScript:filter",p)}}}else{if(d=="="){for(;s<j;s++){if(!f[s].s){m[r++]=this.__cloneR(f[s].r)}}}else{if(d=="!"){h=this.__um;for(c in h){m[s++]=this.__cloneR(h[c].r)}}else{if(d=="!!"){h=this.__um;for(c in h){m[s++]=this.__cloneR(h[c].o)}}else{if(d=="+"){h=this.__am;for(c in h){m[s++]=this.__cloneR(h[c].r)}}else{if(d=="-"){h=this.__rm;for(c in h){m[s++]=this.__cloneR(h[c].r)}}else{if(d=="*"){h=this.__um;for(c in h){m[s++]=this.__cloneR(h[c].r)}h=this.__am;for(c in h){m[s++]=this.__cloneR(h[c].r)}h=this.__rm;for(c in h){m[s++]=this.__cloneR(h[c].r)}}}}}}}}}}return m},column:function(c,d){var f,j,m,t,s,h,k,i,g,q,o,r;/*!*/if(!arguments.length||arguments.length>3){throw jsl.ParamError()}jsl.validate(c,"t(s+,i+)","id");if(arguments.length===2&&!jsl.isNumber(d)){jsl.validate(d,"t(f,sr/^(=|\\\\+|-|!|!!|\\\\*)$)","filter")}if(arguments.length===2&&jsl.isNumber(d)){jsl.validate(d,"i","i1")}if(arguments.length===3){jsl.validate(arguments[1],"i","i1"),jsl.validate(arguments[2],"i","i2")}/*!*/t=0;if(jsl.isString(c)){/*!*/if(!this.__md["."+c]){throw jsl.ParamError("NotDefined:id")}/*!*/r=c+""}else{/*!*/if(!this.__md[c]){throw jsl.ParamError("BadValue:id")}/*!*/r=this.__md[c].id}if(jsl.isNumber(d)){k=d;i=arguments[2];g=this.count();q=k<0?g+k:(+k||0);o=i<0?g+i:(+i||g);g=o-q;if(g>0){m=this.__read(g,this.__index(q));for(j=m.length;t<j;t++){m[t]=m[t].r[r]}}else{m=[]}}else{m=[];f=!jsl.isString(d)||d=="="?this.__read(Infinity,0):null;j=f&&f.length;s=0;if(!d){for(;t<j;t++){m[t]=f[t].r[r]}}else{if(jsl.isFunction(d)){for(;t<j;t++){try{if(d(f[t].r)){m[s++]=f[t].r[r]}}catch(p){throw jsl.ParamError("BadScript:filter",p)}}}else{if(d=="="){for(;t<j;t++){if(!f[t].s){m[s++]=f[t].r[r]}}}else{if(d=="!"){h=this.__um;for(c in h){m[t++]=h[c].r[r]}}else{if(d=="!!"){h=this.__um;for(c in h){m[t++]=h[c].o[r]}}else{if(d=="+"){h=this.__am;for(c in h){m[t++]=h[c].r[r]}}else{if(d=="-"){h=this.__rm;for(c in h){m[t++]=h[c].r[r]}}else{if(d=="*"){h=this.__um;for(c in h){m[t++]=h[c].r[r]}h=this.__am;for(c in h){m[t++]=h[c].r[r]}h=this.__rm;for(c in h){m[t++]=h[c].r[r]}}}}}}}}}}return m},walk:function(f){var d;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(f,"f","action");/*!*/d=this.__read(Infinity,0);try{for(var c=0,b=d.length;c<b;c++){if(f(d[c].r)){break}}}catch(g){throw jsl.ScriptError("BadScript:action",g)}return this},refresh:function(){try{var b,a;/*!*/if(arguments.length){throw jsl.ParamError()}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}if(this.__rn+this.__an+this.__un){throw jsl.MisuseError("e.dst.RefreshNegated")}/*!*/if(this.__cn.refresh){this.__lk=true;b=new jsl.Event;this.throwEvent("beforeRefresh",b);this.__um={};this.__am={};this.__rm={};this.__un=0;this.__an=0;this.__rn=0;this.__fn=0;if(this.__cn.ASY){a=this;this.__cn.refresh(function(c){a.__ds=c;a.__filter();a.__lk=false;a.throwEvent("refresh",b)})}else{this.__ds=this.__cn.refresh();this.__filter();this.__lk=false;this.throwEvent("refresh",b)}}return this}catch(b){this.__lk=false;throw b}},commit:function(){try{var n,j,k,m,h,d,b,l,g,c,i;/*!*/if(arguments.length){throw jsl.ParamError()}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/if(this.__an||this.__un||this.__rn){j=[];m=[];h=[];k=[];if(this.__un){n=0;d=this.__um;for(b in d){j[n++]=d[b].r}}if(this.__un){n=0;d=this.__um;for(b in d){m[n++]=d[b].o}}if(this.__an){n=0;d=this.__am;for(b in d){h[n++]=d[b].r}}if(this.__rn){n=0;d=this.__rm;for(b in d){k[n++]=d[b].r}}l=new jsl.Event;l.updated=j;l.old=m;l.added=h;l.removed=k;this.__lk=true;g=this.throwEvent("beforeCommit",l);c=this;i=function(){var f,a,o;f=c.__am;a=c.__um;for(o in a){a[o].s=null,a[o].o=null}for(o in f){f[o].s=null}c.__um={};c.__am={};c.__rm={};c.__un=0;c.__an=0;c.__rn=0;c.__ods=c.__ds.slice();c.__lk=false;c.throwEvent("commit",l)};if(!g.stop_action){if(this.__cn.ASY){this.__cn.commit({added:h,updated:j,removed:k,old:m},i)}else{this.__cn.commit({added:h,updated:j,removed:k,old:m});i()}}}return this}catch(l){this.__lk=false;throw l}},revert:function(){try{var d,b,f,a,c;/*!*/if(arguments.length){throw jsl.ParamError()}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/if(this.__an||this.__un||this.__rn){d=new jsl.Event;this.__lk=true;this.throwEvent("beforeRevert",d);this.__ds=this.__ods.slice();a=this.__um;for(f in a){c=a[f];c.r=c.o;c.o=null;c.s=null}this.__filter();this.__um={};this.__am={};this.__rm={};this.__un=0;this.__an=0;this.__rn=0;this.__lk=false;this.throwEvent("revert",d)}return this}catch(d){this.__lk=false;throw d}},top:function(){/*!*/if(arguments.length){throw jsl.ParamError()}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/this.__ix=0;this.__lx=0;return this},end:function(){var a;/*!*/if(arguments.length){throw jsl.ParamError()}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/a=this.count();this.__lx=a;this.__ix=a+this.__fn;return this},index:function(a){var b;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(a,"i","ix")}/*!*/if(arguments.length){/*!*/if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/b=a>=0?+a:this.count()+a;if(b!==this.__lx){if(!b){this.__lx=this.__ix=0}else{/*!*/if(b<0){throw jsl.MisuseError("e.dst.NegativePosition")}/*!*/this.__lx=b;this.__ix=this.__fn?this.__index():b}}}return arguments.length?this:this.__lx},next:function(f){var a,b,d,c;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(f,"i++","n")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/c=+f||1;if(this.__ft){d=this.__ds;a=this.__ix+1;b=c;while(b){if(!d[a]||!d[a].__$r||!d[a].f){b--}a++}this.__lx+=c;this.__ix=a-1}else{this.__ix=this.__lx+=c}return this},prev:function(f){var a,b,d,c;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(f,"i++","n")}if(this.__lk){throw jsl.MisuseError("e.dst.Locked")}/*!*/c=+f||1;if(this.__ft){d=this.__ds;a=this.__ix-1;b=c;while(b){if(!d[a]||!d[a].__$r||!d[a].f){b--}a--}a++;/*!*/if(a<0){throw jsl.ParamError("e.dst.NegativePosition")}/*!*/this.__lx-=c;this.__ix=a}else{/*!*/if(this.__ix-c<0){throw jsl.ParamError("e.dst.NegativePosition")}/*!*/this.__ix=this.__lx-=c}return this},page:function(a){var c;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(a,"i","ix")}/*!*/if(arguments.length){try{c=this.index(a*this.__ps)}catch(b){throw b instanceof jsl.MisuseError?b.clearStackTrace():b}}return arguments.length?this:Math.floor(this.__lx/this.__ps)},nextPage:function(c){var a;if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(c,"i++","n")}a=((+c||1)-1)*this.__ps;a=this.__ps-this.__lx%this.__ps+a;try{this.next(a)}catch(b){throw b instanceof jsl.MisuseError?b.clearStackTrace():b}return this},prevPage:function(c){var a;if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(c,"i++","n")}a=(+c||1)*this.__ps;a=this.__lx%this.__ps+a;try{this.prev(a)}catch(b){throw (b instanceof jsl.MisuseError?b.clearStackTrace():b)}return this},__filter:function(){var i,d,f,c;i=this.__ft;if(i){d=0;c=this.__lx;f=this.__ds;this.__read(Infinity,0);try{for(var b=0,h=f.length;b<h;b++){if((f[b].f=!!i(f[b].r))){if(c>=b){c++}d++}}}catch(g){throw jsl.ParamError("e.dst.BadFilter",g)}this.__fn=d;this.__ix=c}},__read:function(f,h){var g,o,t,j,i,q,c,m,l,d,s,k,p;g=this.__ds;o=this.__md;j=this.__ft;s=this.__hds;t=o.length;l=jsl.DataSource.__fromNative;f=f||1;h=h!=null?h:this.__ix;q=0;i=[];do{c=g[h];if(c){if(!c.__$r){if(c instanceof Array){c={};for(m=0;m<t;m++){k=o[m];d=k.id;c[d]=s[m]?l(g[h][m],k.type,"rows["+h+"]."+d):g[h][m]}}else{for(m=0;m<t;m++){if(s[m]){d=o[m].id;c[d]=l(c[d],o[m].type,"rows["+h+"]."+d)}}}c=g[h]={r:c,id:this.__id++,__$r:true}}if(!c.f){i[q++]=c;c.ix=h}h++}}while(c&&q<f);return i},__index:function(c){var b,d,a;c=c==null?this.__lx:c;if(this.__fn){b=this.__ds;a=0;d=c+1;while(d){if(!b[a]||!b[a].__$r||!b[a].f){d--}a++}a--}else{a=c}return a}});jsl.DataSource.DataSet.prototype.__type=function(d,c,a){var b;a=a||"value";b=this.__md["."+d].type;switch(b){case"blob":if(c!=null&&!(jsl.Data.Blob.isClassOf(c))){throw jsl.ParamError("BadType:"+a+":jsl.Data.Blob")}break;case"xml":if(c!=null&&!(jsl.Data.XNode.isClassOf(c))){throw jsl.ParamError("BadType:"+a+":jsl.Data.XNode")}break;case"any":break;case"json":if(c!=null&&!jsl.isObject(c)){throw jsl.ParamError("BadType:"+a+":object")}break;case"v":break;default:jsl.validate(c,b,a)}};jsl.DataSource.DataSet.prototype.__sort=function(f,d){var g,h;g=arguments.callee.data;for(var c=0,b=g.length;c<b;c++){h=g[c][0];if(f.r[h]!==d.r[h]){break}}if(c===b){return 0}else{if(f.r[h]<d.r[h]){return g[c][1]?+1:-1}else{return g[c][1]?-1:+1}}};jsl.DataSource.DataSet.prototype.__exp=function(m,A){var k,w,g,y,B,q,c,f,o,z,C,d,h,i,b,v,j,u,D,r,x,t;k={};D=this.__md;w=["(\\\\s+)","(@\\\\d{0,2})","([()])","(true|false)","(\'(?:[^\'\\n\\r]|(?:\'\'))*\')","([+-]?\\\\d+(?:\\\\.\\\\d+)?)","([a-zA-Z_$]\\\\w*)","([+-/*.])","(<=|>=|!=|!>|=>|[<>=])","([&|])","([\\\\s\\\\S])"];w=RegExp(w.join("|"),"g");g={b:1,s:2,n:3,i:3,N:3,I:3};y=function(a){throw jsl.ParamError("e.dst.exp."+(a||"SyntaxError"))};B=0;c=0;f=0;o=0;z=0;q=null;C=0;d=[];h=[];while((i=w.exec(m))){if(i[1]){d[C]=h[C++]=i[1];continue}else{if(i[2]){if(B>0){y()}v=+(i[2].slice(1)||1);if(v===0){y("InvalidMarkerId")}if(v>A.length){y("ParamNotDefined:"+v+":"+v)}t=A[v-1];if(jsl.isDate(t)){t=+t}if(t==null){i[7]="null"}else{if(jsl.isBoolean(t)){i[4]=t+""}else{if(jsl.isString(t)){i[5]="\'"+t.replace(/\\n/g,"\\\\n").replace(/\'/g,"\'\'")+"\'"}else{if(jsl.isNumber(t)){i[6]=t+""}else{y("InvalidParam:"+v)}}}}}}if(i[3]){if(i[3]==="("){if(B>0){y()}c++;if(B===-1&&!f){f=c}d[C]=h[C++]="(";o=C;B=0}else{if(B<=0){y()}if(c===0){y()}if(q===c){b=1}if(f===c){f=null}if(q===c&&z){z=0;h[C]=" + \'$\') "+(z===1?"=== 0":"!== 0")+")"}else{h[C]=")"}d[C++]=")";c--;B=3}}else{if(i[4]){if(B>0){y()}if(b&&b!==1){y("InvalidOpOnBExp")}d[C]=h[C++]=i[4];B=1;b=1}else{if(i[5]){if(B>0){y()}if(b&&b!==2){y("InvalidOpOnSExp")}d[C]=i[5];h[C++]="\'"+i[5].slice(1,-1).replace(/\'\'/g,"\\\\\'")+"\'";B=1;b=2}else{if(i[6]){if(B>0){y()}if(b&&b!==3){y("InvalidOpOnNExp")}d[C]=h[C++]=i[6];B=1;b=3}else{if(i[7]){if(B>0){y()}if(i[7]!=="null"){if(!D["."+i[7]]){y("InvalidField:"+i[7])}j=D["."+i[7]].type;k.virtual=j==="v";j=g[j.slice(0,1)];if(!b){b=j}else{if(j!==b){y("InvalidIdType:"+i[7])}}}d[C]=h[C++]=i[7];B=2}else{if(i[8]){if(B<=0){y()}if(b===1){y("InvalidOpOnBExp")}if(b===2&&i[8]!=="."){y("InvalidOpOnSExp")}if(b===3&&i[8]==="."){y("InvalidOpOnNExp")}if(i[8]==="."){h[C]="+"}else{h[C]=i[8]}d[C++]=i[8];B=-1}else{if(i[9]){if(B<=0){y()}if(b===1&&i[9]!=="!="&&i[9]!=="="){y("InvalidOpOnBExp")}if(b===3&&(i[9]==="=>"||i[9]==="!>")){y("InvalidOpOnNExp")}if(f){y()}if(q!=null){y()}if(i[9]==="=>"||i[9]==="!>"){h[C]=").search(\'^\' + ",h[o]="("+h[o],z=i[9]==="=>"?1:2}else{if(i[9]==="="){h[C]="=="}else{h[C]=i[9]}}d[C++]=i[9];B=-2;q=c}else{if(i[10]){if(B<=0){y()}if(q==null){y()}if(q<c){y()}if(z){h[C]=" + \'$\') "+(z===1?"=== 0":"!== 0")+i[10]+i[10]}else{h[C]=i[10]+i[10]}d[C]=i[10];C++;B=-3;f=0;b=0;o=C;q=null;z=null}else{if(i[11]){if(i[11].charAt(0)==="\'"){y("UnclosedString")}else{y("InvalidToken:"+i[11].replace(/:/g,"\\\\:"))}}}}}}}}}}if(z){if(B===1){h[C-1]=h[C-1].replace(/((?:\\\\\\\\)+)|(\\\\%)|(\\\\_)|(%+)|(_+)|(\\\\\'(?!$))|([$.*+?=!:|\\\\\\/()\\[\\]{}^])/g,this.__like)}else{if(B===2){h[C-1]+=".replace(/((?:\\\\\\\\\\\\\\\\)+)|(\\\\\\\\%)|(\\\\\\\\_)|(%+)|(_+)|(\\\\\\\\\'(?!$))|([$.*+?=!:|\\\\\\\\\\\\/()\\\\[\\\\]{}^])/g, arguments.callee.f)"}}}}if(c){y("MissingBracket")}if(B<0){y()}if(q==null){y()}k.exp=d;k.cexp=d.join("");r="var ";for(C=0,x=D.length;C<x;C++){r+=D[C].id+"=r."+D[C].id+(C===x-1?"":",")}r=r+";return "+h.join("");if(z){r+=" + \'$\') "+(z===1?"=== 0":"!== 0")}k.fexp=Function("r",r);k.fexp.f=this.__like2;return k};jsl.DataSource.DataSet.prototype.__like=function(d,c,b,a,i,h,g,f){if(c){return c.replace(/\\\\/g,"\\\\\\\\")}else{if(b){return"%"}else{if(a){return"_"}else{if(i){return"[\\\\\\\\s\\\\\\\\S]*?"}else{if(h){return"[\\\\\\\\s\\\\\\\\S]"+(h.length?"{"+h.length+"}":"")}else{if(g){return g}else{if(d==="\\\\"){return"\\\\\\\\\\\\\\\\"}else{return"\\\\\\\\"+f}}}}}}}};jsl.DataSource.DataSet.prototype.__like2=function(d,c,b,a,i,h,g,f){if(c){return c.replace(/\\\\/g,"\\\\\\\\")}else{if(b){return"%"}else{if(a){return"_"}else{if(i){return"[\\\\s\\\\S]*?"}else{if(h){return"[\\\\s\\\\S]"+(h.length?"{"+h.length+"}":"")}else{if(g){return g}else{if(d==="\\\\"){return"\\\\\\\\"}else{return"\\\\"+f}}}}}}}};jsl.DataSource.DataSet.prototype.__clone=jsl.Object.clone;jsl.DataSource.DataSet.prototype.__cloneR=function(g){var f,b,d;f=this.__md;b=f.length;d={};for(var c=0;c<b;c++){d[f[c].id]=g[f[c].id]}return d};jsl.Interface("jsl.DataSource.Connector",{type:function(){},define:function(b,a){},execute:function(a,c,b){},connect:function(b,c,a){},commit:function(a,b){},refresh:function(a){}});jsl.DataSource.CMemory={type:function(){return"memory"},commit:function(a){}};jsl.defineError("jsl.QueryError",Error,"e.dst.db.BadQuery");jsl.DataSource.CDb={__name:"CDb",__hds:{any:1,json:1,xml:1,blob:1,d:1,b:1},__ds:null,__md:null,__pk:null,__q:null,__dset:null,type:function(){return"db"},define:function(b,a){try{jsl.require("file");try{b.path=jsl.File.getNativePath(b.location)}catch(c){throw jsl.ParamError("BadValue:options.location:path")}}catch(c){jsl.throwError(c,this,arguments)}},connect:function(c,g,p){try{var b,j,d,n,r,h,o,k,m,i;b=p.query!=null?p.query:p.option;if(!g&&b==null){throw jsl.ParamError("Required:id(table) | options.query")}if(g&&b!=null){throw jsl.ParamError("NotRequired:options.query")}if(b!=null){jsl.validate(b,"s+","options.query")}if(p.metadata&&p.metadata.reals){throw jsl.ParamError("e.dst.db.InvalidMetaData:options.metadata")}if(!jsl.DataSource.__ni_db_exists(c.path)){throw jsl.ParamError("NotFound:id(datasource)")}if(g&&!jsl.DataSource.__ni_db_exists(c.path,g)){throw jsl.ParamError("NotFound:id(table)")}if(b&&!b.match(/^\\s*SELECT/i)){throw jsl.QueryError("BadValue:options.query:SELECT")}if(b&&b.replace(/\'([^\']+|\'\')*\'|"([^"]+|"")*"/g,"").indexOf(";")>-1){throw jsl.MisuseError("e.dst.db.NoMultipleQueries")}d=jsl.DataSource;n=this.__getmd(c,g,b);r=n.length;if(g){j="SELECT * FROM "+g}else{n.wr=n.wr&&b.replace(/\'([^\']+|\'\')*\'|"([^"]+|"")*"/g,"").search(/[\\s)]+(UNION|EXCEPT|INTERSECT|GROUP\\s+BY)[\\s(]+/i)===-1;j=b}if(!p.readonly&&n.wr){h=[];for(o=0;o<r;o++){if(n[o].key){h.push(n[o].field)}}if(h.length){this.__pk=h}else{if(g){j="SELECT oid AS __oid, * FROM "+g}else{j=b.replace(/SELECT/i,"SELECT oid AS __oid,")}this.__pk=["__oid"]}}i=n;if(p.metadata){i=i.concat(p.metadata)}m=new d.DataSet(i,{readonly:p.readonly});m.__ds=d.__ni_db_query(c.path,j);if(p.onReady){k=p.onReady;jsl.delay(function(){k(m)},0)}this.__ds=c;this.__md=n;this.__q=j;this.__dset=m;return m}catch(l){jsl.throwError(l,this,arguments)}},execute:function(b,c,g){try{var j,i,a,d,f;jsl.validate(c,"t(s+,o)","command");j=jsl.isString(c)?c:c.sql;if(j==null){throw jsl.ParamError("NullValue:command.sql")}jsl.validate(j,"s+","command.sql");if(b.readonly&&j.search(/^\\s*(EXISTS|SELECT|ANALYZE|EXPLAIN|PRAGMA)/i)===-1){throw jsl.MisuseError("e.ds.ReadOnly")}i=null;d=jsl.DataSource;f=jsl.isString(c)?{}:jsl.Object.clone(c);delete f.sql;j=j.replace(/(\'(?:\'\'|[^\']+)*\'|"(?:""|[^"]+)*")|@([^@\\s()+\\-*\\/"\',=!><%?.\\[\\]\\\\{}&|^]+)/g,function(n,m,k){var o,l;if(k){if(!f.hasOwnProperty(k)){throw jsl.ParamError("e.dst.db.InvalidMarker",[k])}l=d.__toNative(f[k]);if(l==null){return"NULL"}else{if(typeof l==="string"){return"\'"+l.replace(/\'/g,"\'\'")+"\'"}else{return +l+""}}}else{return m}});if(j.match(/^\\s*EXISTS\\s+TABLE/i)){a=j.match(/^\\s*EXISTS\\s+TABLE\\s+(\\S+)\\s*$/i);if(!a){throw jsl.QueryError()}i=d.__ni_db_exists(b.path,a[1])}else{if(j.match(/^\\s*EXISTS\\s+DATABASE/i)){a=j.match(/^\\s*EXISTS\\s+DATABASE\\s*$/i);if(!a){throw jsl.QueryError()}i=d.__ni_db_exists(b.path)}else{if(j.match(/^\\s*CREATE\\s+DATABASE/i)){a=j.match(/^\\s*CREATE\\s+DATABASE\\s*$/i);if(!a){throw jsl.QueryError()}if(d.__ni_db_exists(b.path)){throw jsl.MisuseError("AlreadyCreated",["datasource("+b.id+")"])}d.__ni_db_create(b.path)}else{if(j.match(/^\\s*DROP\\s+DATABASE/i)){a=j.match(/^\\s*DROP\\s+DATABASE\\s*$/i);if(!a){throw jsl.QueryError()}d.__ni_db_remove(b.path)}else{if(!d.__ni_db_exists(b.path)){throw jsl.MisuseError("NotFound",["datasource("+b.id+")"])}i=d.__ni_db_query(b.path,j)}}}}if(g){jsl.delay(function(){g(i)},0)}return i}catch(h){jsl.throwError(h,this,arguments)}},commit:function(b,d){try{var a;a=this;if(d){jsl.delay(function(){a.__commit(b,d)},0)}else{this.__commit(b)}}catch(c){jsl.throwError(c,this,arguments)}},refresh:function(g){try{var b,c,a;a=this;c=function(){b=jsl.DataSource.__ni_db_query(a.__ds.path,a.__q);g&&g(b)};if(g){jsl.delay(c,0)}else{c()}return b}catch(d){jsl.throwError(d,this,arguments)}},__commit:function(l,d){try{var z,A,t,g,w,q,j,k,h,y,n,c,x,s,p,i,m,f,o;if(this.__md.wr){z=[];A=this.__md;g=A.length;w=this.__pk;w=w.length===1&&w[0]==="__oid"?null:w;i=w&&w.length;t=A.tid;f=this.__hds;if(w||!l.added.length){this.execute(this.__ds,"BEGIN")}else{this.execute(this.__ds,"BEGIN IMMEDIATE");j=this.execute(this.__ds,"SELECT max(rowid) AS id FROM "+t);j=j.length?j[0].id:0}q=true;p=jsl.DataSource;k=l.added;for(y=0,c=k.length;y<c;y++){n=k[y];o={};s="INSERT INTO "+t+(w?" (":" (rowid,");for(x=0;x<g;x++){if(A[x].wr&&!o[A[x].field]){s+=A[x].field+",";o[A[x].field]=true}}o={};s=s.slice(0,-1)+") VALUES (";s+=(w?"":++j+",");for(x=0;x<g;x++){if(A[x].wr&&!o[A[x].field]){m=f[A[x].type]?p.__toNative(n[A[x].id],A[x].type):n[A[x].id];o[A[x].field]=true;if(m==null){s+="NULL,"}else{if(A[x].type==="blob"){s+="X\'"+m+"\',"}else{if(typeof m==="string"){s+="\'"+m.replace(/\'/g,"\'\'")+"\',"}else{s+=+m+","}}}}}s=s.slice(0,-1)+")";z.push(s)}k=l.removed;for(y=0,c=k.length;y<c;y++){s="DELETE FROM "+t+" WHERE ";n=k[y];if(w){for(x=0;x<i;x++){s+=w[x]+"=";m=f[A[x].type]?p.__toNative(n[w[x]]):n[w[x]];if(m==null){s+="NULL AND "}else{if(typeof m==="string"){s+="\'"+m.replace(/\'/g,"\'\'")+"\' AND "}else{s+=+m+" AND "}}}s=s.slice(0,-5)}else{s+="rowid="+k[y].__oid}z.push(s)}k=l.updated;h=l.old;for(y=0,c=k.length;y<c;y++){n=k[y];o={};s="UPDATE "+t+" SET ";for(x=0;x<g;x++){if(A[x].wr&&!o[A[x].field]){s+=A[x].field+"=";m=f[A[x].type]?p.__toNative(n[A[x].id]):n[A[x].id];o[A[x].field]=true;if(m==null){s+="NULL,"}else{if(A[x].type==="blob"){s+="X\'"+m+"\',"}else{if(typeof m==="string"){s+="\'"+m.replace(/\'/g,"\'\'")+"\',"}else{s+=+m+","}}}}}s=s.slice(0,-1)+" WHERE ";if(w){for(x=0;x<i;x++){s+=w[x]+"=";m=f[A[x].type]?p.__toNative(h[y][w[x]]):h[y][w[x]];if(m==null){s+="NULL AND "}else{if(typeof m==="string"){s+="\'"+m.replace(/\'/g,"\'\'")+"\' AND "}else{s+=+m+" AND "}}}s=s.slice(0,-5)}else{s+="rowid="+k[y].__oid}z.push(s)}this.execute(this.__ds,z.join(";")+";COMMIT");q=false;d&&d()}else{if(this.__dset.getName()!=="jsl.DataSource.DataSet"){jsl.console.info("info.dst.db.SilentCommit",[this.__dset.getName()])}else{jsl.console.info("info.dst.db.SilentCommit",[this.__dset.__n])}}}catch(u){if(q){this.execute(this.__ds,"ROLLBACK")}throw u}},__getmd:function(f,h,b){var d,j,c,n,m;if(h){b="SELECT * FROM "+h+"  LIMIT 0"}else{b="SELECT * FROM ("+b+") LIMIT 0"}d=jsl.DataSource.__ni_db_metadata(f.path,b);j=[];for(var k=0,g=d.length;k<g;k++){c=d[k];n=c.type&&c.type.toUpperCase();if(!n||n==="ANY"){n="any"}else{if(n==="INT_P"){n="i++"}else{if(n==="INT_NN"){n="i+"}else{if(n==="REAL_P"){n="n++"}else{if(n==="REAL_NN"){n="n+"}else{if(n==="BOOL"){n="b"}else{if(n==="DATE"){n="d"}else{if(n==="XML"){n="xml"}else{if(n==="JSON"){n="json"}else{if(n==="TEXT_NE"){n="s+"}else{if((/INT/).test(n)){n="i"}else{if((/BLOB/).test(n)){n="blob"}else{if((/CHAR|CLOB|TEXT/i).test(n)){n="s"}else{n="n"}}}}}}}}}}}}}j[k]={wr:c.wr,id:c.id,field:c.field,key:c.key,type:n};m=c.value;if(m!=null&&m!=="null"){if(n==="b"){m=m==="1"}else{if(!m.search(/^x\'/i)){m=m.slice(2,-1)}else{if(m.charAt(0)==="\'"){m=m.slice(1,-1).replace(/\'\'/g,"\'")}else{m=+m}}}try{j[k].value=jsl.DataSource.__fromNative(m,n,c.id+"(default)")}catch(i){throw jsl.DataError("e.dst.db.BadMetaData",[c.id],i)}}}j.tid=d.table;j.wr=d.wr;return j}};jsl.DataSource.type("db",jsl.DataSource.CDb);jsl.DataSource.CNet={__name:"CNet",__ds:null,__tid:null,__md:null,__ps:null,__hds:{any:1,json:1,xml:1,blob:1,d:1},type:function(){return"net"},define:function(b,a){try{if(b.request!=null){jsl.validate(b.request,"f","options.request")}if(b.response!=null){jsl.validate(b.response,"f","options.response")}if(b.params!=null){jsl.validate(b.params,"o","options.params")}jsl.require("data");try{jsl.Url(b.location)+""}catch(c){throw jsl.ParamError("BadValue:options.location:URL",c)}}catch(c){jsl.throwError(c,this,arguments)}},connect:function(b,c,k){try{var a,j,g,d,i;if(k.hasOwnProperty("option")){throw jsl.ParamError("BadType:options:object")}if(k.params!=null){jsl.validate(k.params,"o","options.params")}if(k.metadata&&!k.metadata.reals){throw jsl.ParamError("e.dst.net.BadMetaData2:options.metadata")}this.__ds=b;this.__tid=c;this.__md=k.metadata;a=this.__ps={};if(b.params){jsl.Object.merge(a,b.params)}if(k.params){jsl.Object.merge(a,k.params)}j=this;g=function(r){var o,p,q;o=r.rows;p=o&&o.length;if(!j.__md){j.__md=j.__getmd(r)}if(o==null){throw jsl.DataError("e.dst.net.BadRows:NULL")}if(!(o instanceof Array)){throw jsl.DataError("e.dst.net.BadRows:"+typeof o)}for(var n=0,m=o.length;n<m;n++){if(typeof o[n]!=="object"){throw jsl.DataError("e.dst.net.BadRowType",[n,typeof o[n]])}}q=k.onReady;i=new jsl.DataSource.DataSet(j.__md,{readonly:k.readonly});i.__ds=o;q&&q(i)};d={};if(c){d.table=c}if(k.onReady){this.__cmd("connect",this.__ds,d,g);i=null}else{d=this.__cmd("connect",this.__ds,d);g(d)}return i}catch(h){jsl.throwError(h,this,arguments)}},execute:function(c,g,f){try{var a,b;jsl.validate(g,"t(o,s+)","command");a=null;b=jsl.isString(g)?{data:g}:g;if(f){this.__cmd("execute",c,b,f)}else{a=this.__cmd("execute",c,b).result}return a}catch(d){jsl.throwError(d,this,arguments)}},commit:function(s,j){try{var g,i,h,o,d,n,m,q,c,p,f;m=this.__md;q=m.length;f=jsl.DataSource;p=this.__hds;h={};h.added=i=[];g=s.added;for(o=0,d=g.length;o<d;o++){i[o]=c=[];for(n=0;n<q;n++){c[n]=p[m[n].type]?f.__toNative(g[o][m[n].id],m[n].type):g[o][m[n].id]}}h.removed=i=[];g=s.removed;for(o=0,d=g.length;o<d;o++){i[o]=c=[];for(n=0;n<q;n++){c[n]=p[m[n].type]?f.__toNative(g[o][m[n].id],m[n].type):g[o][m[n].id]}}h.old=i=[];g=s.old;for(o=0,d=g.length;o<d;o++){i[o]=c=[];for(n=0;n<q;n++){c[n]=p[m[n].type]?f.__toNative(g[o][m[n].id],m[n].type):g[o][m[n].id]}}h.updated=i=[];g=s.updated;for(o=0,d=g.length;o<d;o++){i[o]=c=[];for(n=0;n<q;n++){c[n]=p[m[n].type]?f.__toNative(g[o][m[n].id],m[n].type):g[o][m[n].id]}}this.__cmd("commit",this.__ds,{table:this.__tid,rows:h},j)}catch(k){jsl.throwError(k,this,arguments)}},refresh:function(g){try{var h,b,a,d;h=this;b=function(l){var i,j,k;i=l.rows;j=i&&i.length;if(i==null){throw jsl.DataError("e.dst.net.BadRows:NULL")}if(!(i instanceof Array)){throw jsl.DataError("e.dst.net.BadRows:"+typeof i)}k=g;k&&k(l.rows)};if(g){this.__cmd("connect",this.__ds,{table:this.__tid},b);a=null}else{d=this.__cmd("connect",this.__ds,{table:this.__tid});b(d);a=d.rows}return a}catch(c){jsl.throwError(c,this,arguments)}},__type:function(a){var b,c;c=jsl.Data;if(typeof a==="number"){b="n"}else{if(typeof a==="boolean"){b="b"}else{if(typeof a==="string"){b="s"}else{if(a instanceof Date){b="d"}else{if(c.Blob.isClassOf(a)){b="blob"}else{if(c.XNode.isClassOf(a)){b="xml"}else{b="any"}}}}}}return b},__getmd:function(h){var f,c,d,b,i;c=h.rows;d=c&&c.length;if(h.metadata){f=h.metadata}else{if(d){if(typeof c[0]!=="object"){throw jsl.DataError("e.dst.net.BadRowType",[0,typeof c[0]])}f=[];if(c[0] instanceof Array){for(b=0;b<c[0].length;b++){f[b]={id:"col"+b,type:this.__type(c[0][b])}}}else{b=0;for(i in c[0]){f[b++]={id:i,type:this.__type(c[0][i])}}f.sort(function(j,a){return j.id<=a.id?-1:1})}}else{throw jsl.ParamError("e.dst.net.MetaDataNotFound")}}try{f=jsl.DataSource.__md(f)}catch(g){throw jsl.DataError("e.dst.net.BadMetaData",g)}return f},__cmd:function(b,d,i,j){var k,n,h,g,c,m;c=this.__ps||d.params?jsl.Object.clone(this.__ps||d.params):{};c=jsl.Object.merge(c,i);c.command=b;c.datasource=d.id;c={url:jsl.Url(d.location),input:c,output:null};k=d.request;if(k){try{n=k(c)}catch(l){throw jsl.ParamError("BadScript:options.request",l)}if(!jsl.isObject(n)){throw jsl.ParamError("BadReturnValue:options.request:object")}}else{n=c.url}if(n instanceof jsl.Url.HttpUrl||n instanceof jsl.Url.HttpsUrl){if(c.output!=null){if(!jsl.isObject(c.output)){throw jsl.MisuseError("BadType:request(data.output):object")}g=c.output}else{g={};for(var a in c.input){if(c.input.hasOwnProperty(a)){if(c.input[a]&&typeof c.input[a]==="object"){g[a]=jsl.Data.toJson(c.input[a],jsl.Data.__JSN_OPTS)}else{g[a]=c.input[a]}}}}k=d.response;if(j){m=this;g.onService=function(p){var o,f;f=m.__cm_f(p.data,c);j(f)};jsl.service(n,{content:k?"text":"json",data:g});n=null}else{try{h=jsl.service(n,{content:k?"text":"json",data:g})}catch(l){h={error:l}}n=this.__cmd_f(h,c,k)}}return n},__cmd_f:function(g,b,c){var a;if(jsl.isObject(g)&&g.error){throw jsl.DataError(g.error)}if(c){try{a=c(b,g)}catch(d){throw jsl.ParamError("BadScript:options.response",d)}if(!jsl.isObject(a)){throw jsl.ParamError("BadReturnValue:options.response:object")}}else{a=g}return a}};jsl.DataSource.type("net",jsl.DataSource.CNet);if(jsl.__sid==="V8cgi"){jsl.DataSource.__ni_db_create=jsl.DataSource.__ni_db_remove=jsl.DataSource.__ni_db_query=jsl.DataSource.__ni_db_metadata=jsl.DataSource.__ni_db_connect=jsl.DataSource.__ni_db_exists=function(){throw jsl.NativeError("the V8CGI support is ended. Soon Liquid will have a own desktop system")}}else{if(jsl.__sid==="Rhino"){(function(){try{jsl.DataSource.__ni_db_cns={};var a=java.util.logging.Logger.getLogger("com.almworks.sqlite4java");a.setLevel(java.util.logging.Level.OFF)}catch(b){jsl.throwError(b,"jsl.DataSource.native.init")}})();jsl.DataSource.__ni_db_create=function(b){try{this.__ni_db_connect(b)}catch(a){jsl.throwError(jsl.NativeError(a),this,arguments)}};jsl.DataSource.__ni_db_remove=function(g){try{var a,c;if(this.__ni_db_cns[g]){this.__ni_db_cns[g].dispose();delete this.__ni_db_cns[g]}c=new java.io.File(g);if(c.isFile()){a=c["delete"]();if(!a){throw jsl.NativeError("OperationFailed")}}}catch(d){jsl.throwError(jsl.NativeError(d),this,arguments)}};jsl.DataSource.__ni_db_exists=function(g,d){try{var b,a;if(!d&&this.__ni_db_cns[g]){a=true}else{b=new java.io.File(g);a=false;if(b.isFile()){try{this.__ni_db_connect(g);if(d){a=!!this.__ni_db_query(g,"SELECT 1 FROM sqlite_master WHERE type = \'table\' and lower(name) = \'"+d.toLowerCase()+"\'").length}else{a=true}}catch(c){}}}return a}catch(c){jsl.throwError(jsl.NativeError(c),this,arguments)}};jsl.DataSource.__ni_db_query=function(y,x){try{var t,w,d,j,c,k,s,q,r,u,f,m,g,p;t=this.__ni_db_connect(y);if((/^[\\s\\n\\r]*(ANALYZE|EXPLAIN|SELECT|PRAGMA)/i).test(x)){try{w=t.prepare(x)}catch(o){throw jsl.QueryError("e.dst.db.BadQuery",o)}d=w.columnCount();j=[];c=[];k=0;f={10:"A",11:"B",12:"C",13:"D",14:"E",15:"F"};if(w.step()){for(s=0;s<d;s++){c[s]={id:w.getColumnName(s)+"",type:+w.columnType(s)}}do{j[k]={};for(s=0;s<d;s++){r=c[s].type;if(r<=2){j[k][c[s].id]=+w.columnString(s)}else{if(r===3){j[k][c[s].id]=w.columnString(s)==null?null:w.columnString(s)+""}else{if(r===4){j[k][c[s].id]=w.columnBlob(s)}else{j[k][c[s].id]=null}}}if(r==5){u=w.columnValue(s);if(u==null){j[k][c[s].id]=null}else{if(u instanceof java.lang.String){j[k][c[s].id]=w.columnString(s)+""}else{if(u instanceof java.lang.Number){j[k][c[s].id]=+w.columnString(s)}else{j[k][c[s].id]=w.columnBlob(s),r=4}}}}if(r===4&&j[k][c[s].id]!=null){u=j[k][c[s].id];p=[];for(q=0;q<u.length;q++){m=u[q]>>>4;g=u[q]&15;m=f[m]||m+"";p[q]=m+(f[g]||g)}j[k][c[s].id]=p.join("")}}k++}while(w.step())}w.dispose()}else{try{t.exec(x)}catch(o){throw jsl.QueryError("e.dst.db.BadQuery",o)}}return j||null}catch(o){jsl.throwError(o instanceof jsl.QueryError?o:jsl.NativeError(o),this,arguments)}};jsl.DataSource.__ni_db_connect=function(b){try{var c;if(!this.__ni_db_cns[b]){this.__ni_db_cns[b]=c=new com.almworks.sqlite4java.SQLiteConnection(new java.io.File(b));c.open()}return this.__ni_db_cns[b]}catch(a){jsl.throwError(jsl.NativeError(a),this,arguments)}};jsl.DataSource.__ni_db_metadata=function(q,g){try{var h,s,r,G,C,y,i,d,o,B,m,l,E,u,D,f,p,w,F;h=this.__ni_db_cns[q];try{s=h.prepare(g)}catch(z){throw jsl.QueryError("e.dst.db.BadQuery",z)}r=s.columnCount();G=[];E=[];u={};f={};F={};w=0;for(C=0;C<r;C++){D=s.getColumnDatabaseName(0);D=D=="main"||D==null?"":D+"";y=s.getColumnTableName(C);i=""+s.getColumnName(C);d=""+s.getColumnOriginName(C);if(y){p=D?D+"."+y:y;if(!f[p]){try{o=this.__ni_db_query(q,"PRAGMA "+(D?D+".":"")+"table_info("+y+")")}catch(z){throw jsl.QueryError("e.dst.db.BadQuery",z)}f[p]=o;if(!E.length){for(var A=0;A<o.length;A++){if(o[A].pk==1){F[o[A].name]=true,w++}}}}else{o=f[p]}y=D?D+"."+y:y;if(!E["."+y]){E["."+y]=true;E.push(y)}for(B=0;B<o.length;B++){if(o[B].name===d){o=o[B];break}}G[C]={wr:true,id:i,field:d,table:y,type:o.type,key:o.pk==1,value:o.dflt_value+""};u[y+d]=true}else{G[C]={id:i=="null"||i.search(/^[^(\\s+\\-\\/*|&=\'"%\\\\?^[.,;:<>~\\d][^(\\s+\\-\\/*|&=\'"%\\\\?^[.,;:<>~]*$/i)?"col"+C:i,type:"any",key:false,value:"null"}}}var j=0;for(A=0;A<G.length;A++){if(G[A].table==E[0]&&F[G[A].field]){j++;delete F[G[A].field]}}G.wr=E.length===1&&j===w;G.table=E[0];s.dispose();return G}catch(z){s&&s.dispose();jsl.throwError(z instanceof jsl.QueryError?z:jsl.NativeError(z),this,arguments)}}}else{if(jsl.__sid==="AdobeAIR"){jsl.DataSource.__ni_db_create=jsl.DataSource.__ni_db_remove=jsl.DataSource.__ni_db_exists=jsl.DataSource.__ni_db_query=jsl.DataSource.__ni_db_metadata=function(){throw jsl.NativeError("the AdobeAIR support is ended. Soon Liquid will have a own desktop system")}}}}};'