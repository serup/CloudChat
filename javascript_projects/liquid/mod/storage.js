	
	/*
		Copyright (c) 2010-2013 Liquid Working Group. All Rights Reserved.
		Available on MIT license (see: http://www.jsliquid.com/license.html)
	*/
	
	jsl.__ploads.storage='try{jsl}catch(e){throw Error("liquid(error) >> [Storage] module not loaded - cause: jsl core not found")}if(!jsl||jsl.__magic!=="J345NN48H756PQ56"){throw Error("liquid(error) >> [Storage] module not loaded - cause: jsl core not found (bad magic number)")}if(!jsl.__ready){throw Error("liquid(error) >> [Storage] module not loaded - cause: previous jsl core error")}if(jsl.__mods.storage){jsl.console.warn("[Storage] module already loaded")}if(!jsl.__mods.storage){jsl.__mods.push("storage");jsl.__mods.storage="0.82";if(jsl.__mods.storage!==jsl.__version){throw jsl.ConfigError("BadVersion",["Storage module",jsl.__mods.storage,jsl.__version])}jsl.require("data");jsl.setMessage("e.storage.CreationFailed","storage directory creation failed at $");jsl.setMessage("e.storage.Overflow","storage overflow");jsl.setMessage("e.storage.BadSize","<$> wrong value. The storage contains data that will be corrupted if its size is decreased to this value. Clean the storage first or remove some data to proceed.");jsl.Storage=(function(){try{var a=new jsl.Module("jsl.Storage");a.__load=false;a.__uz=false;a.__table=null;a.__size=null;a.__map={};a.__dsize=0;a.addEvents("beforeLoad","beforeSave","beforeUpdate","beforeInsert","beforeRead","beforeRemove","beforeClear","beforeOverflow");a.addEvents("load","save","update","insert","read","remove","clear","overflow");a.setEventAction("overflow",function(c){throw jsl.OverflowError("storage.Overflow")});a.addInfo("memory");a.addInfo("memory.size",function(){this.__update();return this.__table.sz});a.addInfo("memory.used",function(){return this.size()});a.addInfo("memory.free",function(){return -this.size()+this.__table.sz});a.addInfo("memory.metadata",function(){this.__update();return this.__dsize?jsl.Data.serialize(this.__table).length:0});a.addInfo("memory.data",function(){this.__update();return this.__dsize});return a}catch(b){jsl.throwError(b,"jsl.Storage")}})();jsl.Storage.load=function(a){try{/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(a,"i+","size")}if(this.__load){throw jsl.MisuseError()}/*!*/this.__size=+a;this.__update();return this}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.save=function(a,k,c){try{var g,h,m,f,n,i,l,j;/*!*/if(arguments.length<2||arguments.length>3){throw jsl.ParamError()}jsl.validate(a,"s+","id");if(arguments.length===3){jsl.validate(c,"i+","ttl")}/*!*/this.__update();j=a+"";if(j.charAt(0)==="!"){n=jsl.Data.serialize(k,{compress:true}),j=j.slice(1)}else{n=jsl.Data.serialize(k)}g={id:j,value:k,ttl:+c||0,txt:n};h=this.throwEvent("beforeSave",g);m=this.__table;f=l=this.__map[j];if(!h.stop_sequence){if(l){h=this.throwEvent("beforeUpdate",g)}else{h=this.throwEvent("beforeInsert",g)}}if(this.size()-(f&&f.size||0)+n.length>this.__table.sz){h=this.throwEvent("beforeOverflow",g);if(!h.stop_sequence){this.throwEvent("overflow",g)}}else{if(l){f.tou=+new Date;f.ttl=arguments.length===3?+c:f.ttl}else{f={};f.id=j;f.toc=+new Date;f.tou=f.toc;f.ttl=+c||0;m.push(f)}this.__dsize+=n.length-(f.size||0);f.size=n.length;this.__map[j]=f;i=this.__ni_save(j,n);if(!i){h=this.throwEvent("beforeOverflow",g);if(!h.stop_sequence){this.throwEvent("overflow",g)}}else{if(!h.stop_sequence){if(l){h=this.throwEvent("update",g)}else{h=this.throwEvent("insert",g)}if(!h.stop_sequence){this.throwEvent("save",g)}}}}return this}catch(g){jsl.throwError(g,this,arguments)}};jsl.Storage.read=function(g){try{var c,f,a,b;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(g,"s+","id");/*!*/this.__update();c={id:g+"",exists:this.__map.hasOwnProperty(g)};f=this.throwEvent("beforeRead",c);b=this.__ni_read(g);a=b!=null?jsl.Data.deserialize(b):undefined;if(!f.stop_sequence){c.value=a;this.throwEvent("read",c)}return a}catch(c){jsl.throwError(c,this,arguments)}};jsl.Storage.exists=function(b){try{/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(b,"s+","id");/*!*/this.__update();return this.__map.hasOwnProperty(b)}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.remove=function(n){try{var i,j,k,f,c;/*!*/if(arguments.length!==1){throw jsl.ParamError()}jsl.validate(n,"s+","id");/*!*/if(!this.__uz){this.__update()}f=this.__map;c=f[n];if(c){j={id:n+""};k=this.throwEvent("beforeRemove",j);i=this.__table;this.__dsize-=f[n].size;delete f[n];for(var h=0,g=i.length;h<g;h++){if(i[h].id==n){i.splice(h,1);break}}this.__ni_remove(n);if(!k.stop_sequence){this.throwEvent("remove",j)}}return !!c}catch(j){jsl.throwError(j,this,arguments)}};jsl.Storage.clear=function(){try{var b,c,a;/*!*/if(arguments.length){throw jsl.ParamError()}/*!*/this.__update();b={};c=this.throwEvent("beforeClear",b);a=this.__table;this.__table=[];this.__table.sz=a.sz;this.__map={};this.__dsize=0;this.__ni_clear();if(!c.stop_sequence){this.throwEvent("clear",b)}return this}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.size=function(){try{/*!*/if(arguments.length){throw jsl.ParamError()}/*!*/this.__update();return this.__dsize?this.__dsize+jsl.Data.serialize(this.__table).length:0}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.getMetaData=function(i){try{var h,f,d;/*!*/if(arguments.length>1){throw jsl.ParamError()}if(arguments.length){jsl.validate(i,"s+","id")}if(arguments.length&&!this.__map[i]){throw jsl.ParamError("NotDefined",[i])}/*!*/this.__update();f=this.__table;if(i){d=this.__map[i];h={id:d.id,size:d.size,toc:d.toc,tou:d.tou,ttl:d.ttl}}else{h=[];h.size=this.__dsize;for(var c=0,b=f.length;c<b;c++){d=f[c];h[c]={id:d.id,size:d.size,toc:d.toc,tou:d.tou,ttl:d.ttl}}}return h}catch(g){jsl.throwError(g,this,arguments)}};jsl.Storage.__update=function(){try{var h,f,c,b,g;this.__uz=true;if(!this.__load){g={};h=this.throwEvent("beforeLoad",g);this.__table=f=this.__ni_load();this.__load=true;b=f.length;for(c=0;c<b;c++){this.__dsize+=f[c].size,this.__map[f[c].id]=f[c]}if(!h.stop_sequence){this.throwEvent("load",g)}}f=this.__table;h=+new Date;for(c=0;c<f.length;c++){if(f[c].ttl&&f[c].toc+f[c].ttl*1000<=h){this.remove(f[c--].id)}}this.__uz=false}catch(g){jsl.throwError(g,this,arguments)}};jsl.Storage.__ni_re=/[\\x00-\\x08\\x0b\\x0c\\x0e-\\x1f\\ud800-\\udfff\\ufeff-\\uffff]/g;jsl.Storage.__ni_f=function(a){return"\\\\u"+("000"+a.charCodeAt(0).toString(16)).slice(-4)};jsl.Storage.__ni_n=function(a){return a.replace(this.__ni_re,this.__ni_f)};if(jsl.__sid==="V8cgi"){jsl.Storage.__ni_load=function(){try{var h,k,i,o,p,m,n,c,b,g;g=require("fs");h=jsl.getOption("liquid.url");h=h.match(/^file:\\/\\/\\/(.+)/)[1]+"/../storage";k=new g.Directory(h);b=5*1024*1024;if(!k.exists()){try{k.create()}catch(j){throw jsl.SystemError("storage.CreationFailed",[h],j)}}this.__ni_path=h=h+"/";this.__ni_th=i=new g.File(h+"tbl.i");if(i.exists()){i.open("r");p=i.read().toString("utf-8");o=jsl.Data.deserialize(p);i.close()}else{o=[];o.sz=b}if(this.__size!=null&&o.sz!==(this.__size||b)){/*!*/if(p){m=p.length;c=o.length;for(n=0;n<c;n++){m+=o[n].size}if((this.__size||b)<m){throw jsl.ParamError("storage.BadSize:size")}}/*!*/o.sz=this.__size||b;i.open("w");i.write(this.__ni_n(jsl.Data.serialize(o)));i.close()}return o}catch(j){jsl.throwError(j,this,arguments)}};jsl.Storage.__ni_save=function(i,d){try{var g,c,a;g=new (require("fs").File)(this.__ni_path+jsl.Data.crc32(i)+".s");c=this.__ni_th;g.open("w");c.open("w");try{g.write(this.__ni_n(d));c.write(this.__ni_n(jsl.Data.serialize(this.__table)));g.close();c.close();a=true}catch(h){}return a}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_read=function(d){try{var b,a;b=new (require("fs").File)(this.__ni_path+jsl.Data.crc32(d)+".s");if(b.exists()){b.open("r");a=b.read().toString("utf-8");b.close()}return a}catch(c){jsl.throwError(c,this,arguments)}};jsl.Storage.__ni_remove=function(c){try{var a;a=this.__ni_th;a.open("w");a.write(this.__ni_n(jsl.Data.serialize(this.__table)));a.close();a=new (require("fs").File)(this.__ni_path+jsl.Data.crc32(c)+".s");a.remove()}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.__ni_clear=function(){try{var m,g,h,i,c,k;h=require("fs");k=h.File;g=this.__ni_path;m=new h.Directory(g);c=m.listFiles();i=this.__ni_th;i.open("w");i.write(this.__ni_n(jsl.Data.serialize(this.__table)));i.close();for(var n=0,b=c.length;n<b;n++){if(c[n].slice(-2)===".s"){(new k(g+c[n])).remove()}}}catch(j){jsl.throwError(j,this,arguments)}}}else{if(jsl.__sid==="Rhino"){jsl.Storage.__ni_load=function(){try{var g,j,h,n,o,k,m,c,b;g=jsl.getOption("liquid.url");g=g.match(/^file:\\/\\/\\/(.+)/)[1]+"/../storage";j=new java.io.File(g);b=5*1024*1024;if(!j.exists()){try{j.mkdir()}catch(i){throw jsl.SystemError("storage.CreationFailed",[g],i)}}this.__ni_path=g=g+"/";this.__ni_th=h=new java.io.File(g+"tbl.i");if(h.exists()){o=readFile(g+"tbl.i","utf8")+"";n=jsl.Data.deserialize(o)}else{n=[];n.sz=b}if(this.__size!=null&&n.sz!==(this.__size||b)){/*!*/if(o){k=o.length;c=n.length;for(m=0;m<c;m++){k+=n[m].size}if((this.__size||b)<k){throw jsl.ParamError("storage.BadSize:size")}}/*!*/n.sz=this.__size||b;this.__ni_wt(n)}return n}catch(i){jsl.throwError(i,this,arguments)}};jsl.Storage.__ni_save=function(i,f){try{var h,a,c;c=new java.io.FileOutputStream(new java.io.File(this.__ni_path+jsl.Data.crc32(i)+".s"));c=new java.io.OutputStreamWriter(c,"utf8");c=new java.io.BufferedWriter(c);h=this.__ni_n(f);try{c.write(h);c.close();this.__ni_wt();a=true}catch(g){}return a}catch(g){jsl.throwError(g,this,arguments)}};jsl.Storage.__ni_read=function(c){try{var b=this.__ni_path+jsl.Data.crc32(c)+".s";return(new java.io.File(b)).exists()?readFile(b,"utf8")+"":undefined}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_remove=function(c){try{var a;a=new java.io.File(this.__ni_path+jsl.Data.crc32(c)+".s");if(a.exists()){this.__ni_wt();a["delete"]()}}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.__ni_clear=function(){try{var i,b,g;g=java.io.File;i=new g(this.__ni_path);b=i.listFiles();this.__ni_wt();for(var f=0,c=b.length;f<c;f++){if((b[f]+"").slice(-2)===".s"){(new g(this.__ni_path+b[f]))["delete"]()}}}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_wt=function(b){try{var a;a=new java.io.FileOutputStream(this.__ni_th);a=new java.io.OutputStreamWriter(a,"utf8");a=new java.io.BufferedWriter(a);a.write(this.__ni_n(jsl.Data.serialize(b||this.__table)));a.close()}catch(c){jsl.throwError(c,this,arguments)}}}else{if(jsl.__sid==="AdobeAIR"){jsl.Storage.__ni_load=function(){try{var d,f,i,c,b,g,j;f=parentSandboxBridge.st_read_table();j=parentSandboxBridge.error();if(j){throw j}g=5*1024*1024;if(f){d=jsl.Data.deserialize(f)}else{d=[];d.sz=g}if(this.__size!=null&&d.sz!==(this.__size||g)){/*!*/if(f){i=f.length;b=d.length;for(c=0;c<b;c++){i+=d[c].size}if((this.__size||g)<i){throw jsl.ParamError("storage.BadSize:size")}}/*!*/d.sz=this.__size||g;parentSandboxBridge.st_save_table(this.__ni_n(jsl.Data.serialize(d)));j=parentSandboxBridge.error();if(j){throw j}}return d}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_save=function(i,c){try{var g,a,h;g=this.__ni_n(c);try{parentSandboxBridge.st_save(jsl.Data.crc32(i),g);h=parentSandboxBridge.error();if(h){throw h}parentSandboxBridge.st_save_table(this.__ni_n(jsl.Data.serialize(this.__table)));h=parentSandboxBridge.error();if(h){throw h}a=true}catch(f){}return a}catch(f){jsl.throwError(f,this,arguments)}};jsl.Storage.__ni_read=function(d){try{var a,c;a=parentSandboxBridge.st_read(jsl.Data.crc32(d))||undefined;c=parentSandboxBridge.error();if(c){throw c}return a}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.__ni_remove=function(c){try{var b;parentSandboxBridge.st_save_table(this.__ni_n(jsl.Data.serialize(this.__table)));b=parentSandboxBridge.error();if(b){throw b}parentSandboxBridge.st_remove(jsl.Data.crc32(c));b=parentSandboxBridge.error();if(b){throw b}}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_clear=function(){try{var b;parentSandboxBridge.st_save_table(this.__ni_n(jsl.Data.serialize(this.__table)));b=parentSandboxBridge.error();if(b){throw b}parentSandboxBridge.st_clear();b=parentSandboxBridge.error();if(b){throw b}}catch(a){jsl.throwError(a,this,arguments)}}}else{if(jsl.__go.localStorage){jsl.Storage.__ps={Fennec:function(){return 5242880},Firefox:function(){return 5242880},Flock:function(){return 5242880},Prism:function(){return 5242880},Explorer:function(){return 5000000},"Android-browser":function(){return 2621440},Chrome:function(){return 2621440},Safari:function(){return 2621440},Opera:function(){return 1965822},"Opera-mobile":function(){return 393068}};jsl.Storage.__ni_load=function(){try{var d,f,i,c,b,h;f=localStorage.getItem("~jsl");d=f?jsl.Data.deserialize(f):[];if(this.__size&&d.sz!==this.__size){/*!*/if(f){h=f.length;b=d.length;for(c=0;c<b;c++){h+=d[c].size}if(this.__size<h){throw jsl.ParamError("storage.BadSize:size")}}/*!*/d.sz=this.__size;localStorage.setItem("~jsl",this.__ni_n(jsl.Data.serialize(d)))}else{if(!d.sz||this.__size===0){i=this.__ps[jsl.getInfo("system.id")];i=i&&i();if(!i){localStorage.clear();i=localStorage.remainingSpace;if(!i){f=Array(500001).join(".");c=i=0;while(f.length>250){try{localStorage.setItem("a"+c++,f),i+=f.length}catch(g){f=f.slice(0,Math.ceil(f.length/2))}}localStorage.clear()}}if(d.sz!==i){d.sz=i;localStorage.setItem("~jsl",this.__ni_n(jsl.Data.serialize(d)))}}}return d}catch(g){jsl.throwError(g,this,arguments)}};jsl.Storage.__ni_save=function(j,c){try{var f,g,a,i;f=this.__ni_n(jsl.Data.serialize(this.__table));g=jsl.Data.crc32(j);i=this.__ni_n(c);try{localStorage.setItem(g,i);localStorage.setItem("~jsl",f);a=true}catch(h){}return a}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_read=function(b){try{return localStorage.getItem(jsl.Data.crc32(b))}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_remove=function(b){try{localStorage.removeItem(jsl.Data.crc32(b));localStorage.setItem("~jsl",this.__ni_n(jsl.Data.serialize(this.__table)))}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_clear=function(){try{localStorage.clear();localStorage.setItem("~jsl",this.__ni_n(jsl.Data.serialize(this.__table)))}catch(a){jsl.throwError(a,this,arguments)}}}else{if(jsl.__go.globalStorage){jsl.Storage.__ni_st=globalStorage[window.location.hostname];jsl.Storage.__ni_load=function(){try{var f,g,j,c,b,i,d;d=this.__ni_st;g=d["~jsl"];g=g?g.value:null;f=g?jsl.Data.deserialize(g):[];if(this.__size&&f.sz!==this.__size){if(g){i=g.length;b=f.length;for(c=0;c<b;c++){i+=f[c].size}if(this.__size<i){throw jsl.ParamError("storage.BadSize:size")}}f.sz=this.__size;d["~jsl"]=this.__ni_n(jsl.Data.serialize(f))}else{if(!f.sz||this.__size===0){while(d.length){delete d[d.key(0)]}j=5*1024*1024;if(f.sz!==j){f.sz=j;d["~jsl"]=this.__ni_n(jsl.Data.serialize(f))}}}return f}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_save=function(k,g){try{var f,i,a,j;f=this.__ni_n(jsl.Data.serialize(this.__table));i=this.__ni_n(g);j="_"+jsl.Data.crc32(k);try{this.__ni_st[j]=i;this.__ni_st["~jsl"]=f;a=true}catch(h){}return a}catch(h){jsl.throwError(h,this,arguments)}};jsl.Storage.__ni_read=function(c){try{var a=this.__ni_st["_"+jsl.Data.crc32(c)];return a?a.value:undefined}catch(b){jsl.throwError(b,this,arguments)}};jsl.Storage.__ni_remove=function(b){try{delete this.__ni_st["_"+jsl.Data.crc32(b)];this.__ni_st["~jsl"]=this.__ni_n(jsl.Data.serialize(this.__table))}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_clear=function(){try{var a;a=this.__ni_st;while(a.length){delete a[a.key(0)]}a["~jsl"]=this.__ni_n(jsl.Data.serialize(this.__table))}catch(b){jsl.throwError(b,this,arguments)}}}else{if(jsl.__sid==="Explorer"){jsl.Storage.__ni_load=function(){try{var f,g,j,h,c,b,k;this.__ni_d=j=document.createElement("div");j.style.behavior="url(\'#default#userData\')";document.body.appendChild(j);h=65517*8;k=this.__ni_vs={};g=[];for(c=0;c<8;c++){j.load("jsl"+c);g[c]=j.getAttribute("_");if(!g[c]){break}}g=g.join("");if(g){g=g.replace(/\\uFF22/g,"\\x22");g=g.replace(/\\uFF26/g,"\\x26");g=g.replace(/\\uFF3E/g,"\\x3E");g=g.replace(/\\uFF3C/g,"\\x3C");f=jsl.Data.deserialize(g);for(c=0,b=f.length;c<b;c++){k[f[c].id]=f[c].v;delete f[c].v}}else{f=[];f.sz=h}if(this.__size!=null&&f.sz!==(this.__size||h)){if(g&&(this.__size||h)<g.length){throw jsl.ParamError("storage.BadSize:size")}f.sz=this.__size||h;this.__table=f;this.__ni_save_storage()}return f}catch(i){jsl.throwError(i,this,arguments)}};jsl.Storage.__ni_save=function(c,a){try{this.__ni_vs[c]=this.__ni_n(a);this.__ni_save_storage();return true}catch(b){}};jsl.Storage.__ni_read=function(b){try{return this.__ni_vs[b]}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_remove=function(b){try{delete this.__ni_vs[b];this.__ni_save_storage()}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_clear=function(){try{this.__ni_vs={};this.__ni_save_storage()}catch(a){jsl.throwError(a,this,arguments)}};jsl.Storage.__ni_save_storage=function(){try{var n,m,k,b,h,j,c,f;n=this.__table;m=this.__ni_vs;for(k=0,b=n.length;k<b;k++){n[k].v=m[n[k].id]}h=this.__ni_d;j=this.__ni_n(jsl.Data.serialize(n));f=0;j=j.replace(/\\x22/g,String.fromCharCode(65314));j=j.replace(/\\x26/g,String.fromCharCode(65318));j=j.replace(/\\x3E/g,String.fromCharCode(65342));j=j.replace(/\\x3C/g,String.fromCharCode(65340));for(k=0;k<8;k++){c=j.slice(f,f+65517);if(c){f+=65517;h.setAttribute("_",c)}else{h.removeAttribute("_")}h.save("jsl"+k)}for(k=0,b=n.length;k<b;k++){delete n[k].v}}catch(g){jsl.throwError(g,this,arguments)}}}else{jsl.Storage.__ni_load=function(){throw jsl.NotSupportedError("NotSupported:Storage")}}}}}}}};'